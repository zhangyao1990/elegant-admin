
/**
 * 由 MrZhang 提供技术支持
 * Powered by elegant-admin
 * Github https://github.com/zhangyao1990/elegant-admin
 */

function Qe(n,a){var e=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var t,r,i,s,o=[],u=!0,l=!1;try{if(i=(e=e.call(n)).next,a!==0)for(;!(u=(t=i.call(e)).done)&&(o.push(t.value),o.length!==a);u=!0);}catch(f){l=!0,r=f}finally{try{if(!u&&e.return!=null&&(s=e.return(),Object(s)!==s))return}finally{if(l)throw r}}return o}}function M(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function Ve(n,a){for(var e=0;e<a.length;e++){var t=a[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,We(t.key),t)}}function R(n,a,e){return a&&Ve(n.prototype,a),e&&Ve(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}function h(n,a,e){return a=We(a),a in n?Object.defineProperty(n,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[a]=e,n}function Je(n,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(a&&a.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),a&&ke(n,a)}function ue(n){return ue=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ue(n)}function ke(n,a){return ke=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},ke(n,a)}function $e(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function et(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function tt(n,a){if(a&&(typeof a=="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return et(n)}function rt(n){var a=$e();return function(){var t=ue(n),r;if(a){var i=ue(this).constructor;r=Reflect.construct(t,arguments,i)}else r=t.apply(this,arguments);return tt(this,r)}}function nt(n,a){return st(n)||Qe(n,a)||Pe(n,a)||ut()}function N(n){return it(n)||at(n)||Pe(n)||ot()}function it(n){if(Array.isArray(n))return Ue(n)}function st(n){if(Array.isArray(n))return n}function at(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function Pe(n,a){if(n){if(typeof n=="string")return Ue(n,a);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Ue(n,a)}}function Ue(n,a){(a==null||a>n.length)&&(a=n.length);for(var e=0,t=new Array(a);e<a;e++)t[e]=n[e];return t}function ot(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ut(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function lt(n,a){var e=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(!e){if(Array.isArray(n)||(e=Pe(n))||a){e&&(n=e);var t=0,r=function(){};return{s:r,n:function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}},e:function(u){throw u},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,s=!1,o;return{s:function(){e=e.call(n)},n:function(){var u=e.next();return i=u.done,u},e:function(u){s=!0,o=u},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(s)throw o}}}}function ft(n,a){if(typeof n!="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,a||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(n)}function We(n){var a=ft(n,"string");return typeof a=="symbol"?a:String(a)}var ie={VIDEO:"video",AUDIO:"audio",METADATA:"metadata"},$={AV1:"av1",AVC:"avc",HEVC:"hevc"},Q={AAC:"aac",G711PCMA:"g7110a",G711PCMU:"g7110m",OPUS:"opus"},ne={LARGE_AV_SHIFT:"LARGE_AV_SHIFT",LARGE_VIDEO_GAP:"LARGE_VIDEO_GAP",LARGE_VIDEO_GAP_BETWEEN_CHUNK:"LARGE_VIDEO_GAP_BETWEEN_CHUNK",LARGE_AUDIO_GAP:"LARGE_AUDIO_GAP",AUDIO_FILLED:"AUDIO_FILLED",AUDIO_DROPPED:"AUDIO_DROPPED"},qe=function(){function n(){M(this,n),h(this,"id",1),h(this,"type",ie.VIDEO),h(this,"codecType",$.AVC),h(this,"pid",-1),h(this,"hvcC",void 0),h(this,"codec",""),h(this,"timescale",0),h(this,"formatTimescale",0),h(this,"sequenceNumber",0),h(this,"baseMediaDecodeTime",0),h(this,"baseDts",0),h(this,"duration",0),h(this,"warnings",[]),h(this,"samples",[]),h(this,"pps",[]),h(this,"sps",[]),h(this,"vps",[]),h(this,"fpsNum",0),h(this,"fpsDen",0),h(this,"sarRatio",[]),h(this,"width",0),h(this,"height",0),h(this,"nalUnitSize",4),h(this,"present",!1),h(this,"isVideoEncryption",!1),h(this,"isAudioEncryption",!1),h(this,"isVideo",!0),h(this,"lastKeyFrameDts",0),h(this,"kid",null),h(this,"pssh",null),h(this,"ext",void 0)}return R(n,[{key:"reset",value:function(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}},{key:"exist",value:function(){return/av01/.test(this.codec)?!0:!!(this.pps.length&&this.sps.length&&this.codec)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isVideoEncryption}}]),n}(),Ke=function(){function n(){M(this,n),h(this,"id",2),h(this,"type",ie.AUDIO),h(this,"codecType",Q.AAC),h(this,"pid",-1),h(this,"codec",""),h(this,"sequenceNumber",0),h(this,"sampleDuration",0),h(this,"timescale",0),h(this,"formatTimescale",0),h(this,"baseMediaDecodeTime",0),h(this,"duration",0),h(this,"warnings",[]),h(this,"samples",[]),h(this,"baseDts",0),h(this,"sampleSize",16),h(this,"sampleRate",0),h(this,"channelCount",0),h(this,"objectType",0),h(this,"sampleRateIndex",0),h(this,"config",[]),h(this,"present",!1),h(this,"isVideoEncryption",!1),h(this,"isAudioEncryption",!1),h(this,"kid",null),h(this,"ext",void 0)}return R(n,[{key:"reset",value:function(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}},{key:"exist",value:function(){return!!(this.sampleRate&&this.channelCount&&this.codec&&(this.codecType===Q.AAC||this.codecType===Q.G711PCMA||this.codecType===Q.G711PCMU||this.codecType===Q.OPUS))}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isAudioEncryption}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}}]),n}(),Be=function(){function n(a,e,t){M(this,n),h(this,"flag",{}),h(this,"keyframe",!1),h(this,"gopId",0),h(this,"duration",0),h(this,"size",0),h(this,"units",[]),h(this,"chromaFormat",420),this.originPts=this.pts=a,this.originDts=this.dts=e,t&&(this.units=t)}return R(n,[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),n}(),ae=R(function n(a,e,t,r){M(this,n),h(this,"duration",1024),h(this,"flag",{dependsOn:2,isNonSyncSample:0}),h(this,"keyframe",!0),this.originPts=this.pts=this.dts=a,this.data=e,this.size=e.byteLength,this.sampleOffset=r,t&&(this.duration=t)}),vt=R(function n(a,e){M(this,n),h(this,"time",0),this.data=a,this.originPts=this.pts=e}),ht=function(n){Je(e,n);var a=rt(e);function e(){return M(this,e),a.apply(this,arguments)}return R(e)}(vt),je=function(){function n(){M(this,n),h(this,"id",3),h(this,"type",ie.METADATA),h(this,"timescale",0),h(this,"flvScriptSamples",[]),h(this,"seiSamples",[])}return R(n,[{key:"exist",value:function(){return!!((this.flvScriptSamples.length||this.seiSamples.length)&&this.timescale)}},{key:"reset",value:function(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}},{key:"hasSample",value:function(){return!!(this.flvScriptSamples.length||this.seiSamples.length)}}]),n}(),Xe=function(){function n(a){M(this,n),this.name=a||"",this._prefix="[".concat(this.name,"]")}return R(n,[{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();h(Xe,"disabled",!0);var le=typeof window<"u",Ie=le&&navigator.userAgent.toLocaleLowerCase(),ct=le&&/^((?!chrome|android).)*safari/.test(Ie),dt=le&&Ie.includes("firefox"),pt=le&&Ie.includes("android"),X=function(){function n(){M(this,n)}return R(n,null,[{key:"getRateIndexByRate",value:function(e){return n.FREQ.indexOf(e)}},{key:"parseADTS",value:function(e,t){for(var r=e.length,i=0;i+2<r&&!(e[i]===255&&(e[i+1]&246)===240);)i++;if(!(i>=r)){var s=i,o=[],u=(e[i+2]&60)>>>2,l=n.FREQ[u];if(!l)throw new Error("Invalid sampling index: ".concat(u));for(var f=((e[i+2]&192)>>>6)+1,c=(e[i+2]&1)<<2|(e[i+3]&192)>>>6,v=n._getConfig(u,c,f),d=v.config,g=v.codec,A,p,m=0,U=n.getFrameDuration(l);i+7<r;){if(e[i]!==255||(e[i+1]&246)!==240){i++;continue}if(p=(e[i+3]&3)<<11|e[i+4]<<3|(e[i+5]&224)>>5,!p||r-i<p)break;A=(~e[i+1]&1)*2,o.push({pts:t+m*U,data:e.subarray(i+7+A,i+p)}),m++,i+=p}return{skip:s,remaining:i>=r?void 0:e.subarray(i),frames:o,samplingFrequencyIndex:u,sampleRate:l,objectType:f,channelCount:c,codec:g,config:d,originCodec:"mp4a.40.".concat(f)}}}},{key:"parseAudioSpecificConfig",value:function(e){if(e.length){var t=e[0]>>>3,r=(e[0]&7)<<1|e[1]>>>7,i=(e[1]&120)>>>3,s=n.FREQ[r];if(s){var o=n._getConfig(r,i,t),u=o.config,l=o.codec;return{samplingFrequencyIndex:r,sampleRate:s,objectType:t,channelCount:i,config:u,codec:l,originCodec:"mp4a.40.".concat(t)}}}}},{key:"getFrameDuration",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4;return 1024*t/e}},{key:"_getConfig",value:function(e,t,r){var i=[],s,o;return dt?e>=6?(s=5,o=e-3):(s=2,o=e):pt?(s=2,o=e):(s=r===2||r===5?r:5,o=e,e>=6?o=e-3:t===1&&(s=2,o=e)),i[0]=s<<3,i[0]|=(e&14)>>1,i[1]=(e&1)<<7,i[1]|=t<<3,s===5&&(i[1]|=(o&14)>>1,i[2]=(o&1)<<7,i[2]|=8,i[3]=0),{config:i,codec:"mp4a.40.".concat(s)}}},{key:"getSilentFrame",value:function(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}]),n}();h(X,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);function H(){for(var n=arguments.length,a=new Array(n),e=0;e<n;e++)a[e]=arguments[e];a=a.filter(Boolean);var t=new Uint8Array(a.reduce(function(i,s){return i+s.byteLength},0)),r=0;return a.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}var mt=Math.pow(2,32);function P(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<8)+(n[a+1]||0)}function yt(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<16)+(n[a+1]<<8)+(n[a+2]||0)}function b(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(n[a]<<24>>>0)+(n[a+1]<<16)+(n[a+2]<<8)+(n[a+3]||0)}function re(n){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return b(n,a)*mt+b(n,a+4)}function Ze(n){for(var a="avc1.",e,t=0;t<3;t++)e=n[t].toString(16),e.length<2&&(e="0".concat(e)),a+=e;return a}function Oe(n){if(!Array.isArray(n)){for(var a=[],e="",t=0;t<n.length;t++)t%2&&(e=n[t-1]+n[t],a.push(parseInt(e,16)),e="");return a}return n.map(function(r){return parseInt(r,16)})}function Ae(n,a){return+(n+"."+a)}function gt(n){if(n.length<5)return 0;var a=Math.hypot(n[0],n[3]),e=Math.hypot(n[1],n[4]);return a===0||e===0?0:180*Math.atan2(n[1]/e,n[0]/a)/Math.PI}var J=function(){function n(){M(this,n)}return R(n,null,[{key:"parseAnnexB",value:function(e){for(var t=e.length,r=2,i=0;e[r]!==null&&e[r]!==void 0&&e[r]!==1;)r++;if(r++,i=r+2,i>=t)return[];for(var s=[];i<t;)switch(e[i]){case 0:if(e[i-1]!==0){i+=2;break}else if(e[i-2]!==0){i++;break}r!==i-2&&s.push(e.subarray(r,i-2));do i++;while(e[i]!==1&&i<t);r=i+1,i=r+2;break;case 1:if(e[i-1]!==0||e[i-2]!==0){i+=3;break}r!==i-2&&s.push(e.subarray(r,i-2)),r=i+1,i=r+2;break;default:i+=3;break}return r<t&&s.push(e.subarray(r)),s}},{key:"parseAvcC",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4;if(!(e.length<4)){for(var r=e.length,i=[],s=0,o;s+t<r;)if(o=b(e,s),t===3&&(o>>>=8),s+=t,!!o){if(s+o>r)break;i.push(e.subarray(s,s+o)),s+=o}return i}}},{key:"parseSEI",value:function(e,t){for(var r=e.length,i=t?2:1,s=0,o=0,u="";e[i]===255;)s+=255,i++;for(s+=e[i++];e[i]===255;)o+=255,i++;if(o+=e[i++],s===5&&r>i+16)for(var l=0;l<16;l++)u+=e[i].toString(16),i++;return{payload:e.subarray(i,i+o),type:s,size:o,uuid:u}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,r=[],i=1;i<t-2;)e[i]===0&&e[i+1]===0&&e[i+2]===3?(r.push(i+2),i+=2):i++;if(!r.length)return e;var s=t-r.length,o=new Uint8Array(s),u=0;for(i=0;i<s;u++,i++)u===r[0]&&(u++,r.shift()),o[i]=e[u];return o}}]),n}(),Ce=function(){function n(a){if(M(this,n),h(this,"_bytesAvailable",void 0),h(this,"_bitsAvailable",0),h(this,"_word",0),!a)throw new Error("ExpGolomb data params is required");this._data=a,this._bytesAvailable=a.byteLength,this._bytesAvailable&&this._loadWord()}return R(n,[{key:"bitsAvailable",get:function(){return this._bitsAvailable}},{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(t===0)throw new Error("No bytes available");var r=new Uint8Array(4);r.set(this._data.subarray(e,e+t)),this._word=new DataView(r.buffer).getUint32(0),this._bitsAvailable=t*8,this._bytesAvailable-=t}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{e-=this._bitsAvailable;var t=Math.floor(e/8);e-=t*8,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw new Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),r=this._word>>>32-t;return this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),t=e-t,t>0&&this._bitsAvailable?r<<t|this.readBits(t):r}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if(this._word&2147483648>>>e)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return this.readBits(1)===1}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,r=8,i,s=0;s<e;s++)r!==0&&(i=this.readEG(),r=(t+i+256)%256),t=r===0?t:r}}]),n}(),bt=function(){function n(){M(this,n)}return R(n,null,[{key:"parseAVCDecoderConfigurationRecord",value:function(e){if(!(e.length<7)){for(var t=(e[4]&3)+1,r,i=[],s=[],o=6,u=e[5]&31,l,f=0;f<u;f++)if(l=e[o]<<8|e[o+1],o+=2,!!l){var c=e.subarray(o,o+l);o+=l,i.push(c),r||(r=n.parseSPS(J.removeEPB(c)))}var v=e[o];o++;for(var d,g=0;g<v;g++)d=e[o]<<8|e[o+1],o+=2,d&&(s.push(e.subarray(o,o+d)),o+=d);return{sps:r,spsArr:i,ppsArr:s,nalUnitSize:t}}}},{key:"parseSPS",value:function(e){var t=new Ce(e);t.readUByte();var r=t.readUByte(),i=t.readUByte(),s=t.readUByte();t.skipUEG();var o=420;if(r===100||r===110||r===122||r===244||r===44||r===83||r===86||r===118||r===128||r===138||r===144){var u=t.readUEG();if(u<=3&&(o=[0,420,422,444][u]),u===3&&t.skipBits(1),t.skipUEG(),t.skipUEG(),t.skipBits(1),t.readBool())for(var l=u!==3?8:12,f=0;f<l;f++)t.readBool()&&(f<6?t.skipScalingList(16):t.skipScalingList(64))}t.skipUEG();var c=t.readUEG();if(c===0)t.readUEG();else if(c===1){t.skipBits(1),t.skipUEG(),t.skipUEG();for(var v=t.readUEG(),d=0;d<v;d++)t.skipUEG()}t.skipUEG(),t.skipBits(1);var g=t.readUEG(),A=t.readUEG(),p=t.readBits(1);p===0&&t.skipBits(1),t.skipBits(1);var m=0,U=0,y=0,S=0;t.readBool()&&(m=t.readUEG(),U=t.readUEG(),y=t.readUEG(),S=t.readUEG());var w,B,D,k,C;if(t.readBool()){if(t.readBool()){var I=t.readUByte();switch(I){case 1:w=[1,1];break;case 2:w=[12,11];break;case 3:w=[10,11];break;case 4:w=[16,11];break;case 5:w=[40,33];break;case 6:w=[24,11];break;case 7:w=[20,11];break;case 8:w=[32,11];break;case 9:w=[80,33];break;case 10:w=[18,11];break;case 11:w=[15,11];break;case 12:w=[64,33];break;case 13:w=[160,99];break;case 14:w=[4,3];break;case 15:w=[3,2];break;case 16:w=[2,1];break;case 255:{w=[t.readUByte()<<8|t.readUByte(),t.readUByte()<<8|t.readUByte()];break}}}if(t.readBool()&&t.readBool(),t.readBool()&&(t.readBits(4),t.readBool()&&t.readBits(24)),t.readBool()&&(t.readUEG(),t.readUEG()),t.readBool()){var V=t.readBits(32),z=t.readBits(32);B=t.readBool(),D=z,k=V*2,C=D/k}}return{codec:Ze(e.subarray(1,4)),profileIdc:r,profileCompatibility:i,levelIdc:s,chromaFormat:o,width:Math.ceil((g+1)*16-2*(m+U)),height:(2-p)*(A+1)*16-(p?2:4)*(y+S),sarRatio:w,fpsNum:D,fpsDen:k,fps:C,fixedFrame:B}}}]),n}(),ze=function(){function n(){M(this,n)}return R(n,null,[{key:"parseHEVCDecoderConfigurationRecord",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!(e.length<23)){t=t||{};for(var r=(e[21]&3)+1,i,s,o=[],u=[],l=[],f=23,c=e[22],v,d,g,A=0;A<c;A++){v=e[f]&63,d=e[f+1]<<8|e[f+2],f+=3;for(var p=0;p<d;p++)if(g=e[f]<<8|e[f+1],f+=2,!!g){switch(v){case 32:{var m=e.subarray(f,f+g);i||(i=n.parseVPS(J.removeEPB(m),t)),l.push(m)}break;case 33:{var U=e.subarray(f,f+g);s||(s=n.parseSPS(J.removeEPB(U),t)),o.push(U)}break;case 34:u.push(e.subarray(f,f+g));break}f+=g}}return{hvcC:t,sps:s,spsArr:o,ppsArr:u,vpsArr:l,nalUnitSize:r}}}},{key:"parseVPS",value:function(e,t){t=t||{};var r=new Ce(e);r.readUByte(),r.readUByte(),r.readBits(12);var i=r.readBits(3);return t.numTemporalLayers=Math.max(t.numTemporalLayers||0,i+1),r.readBits(17),n._parseProfileTierLevel(r,i,t),t}},{key:"parseSPS",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};t=t||{};var r=new Ce(e);r.readUByte(),r.readUByte(),r.readBits(4);var i=r.readBits(3);t.numTemporalLayers=Math.max(i+1,t.numTemporalLayers||0),t.temporalIdNested=r.readBits(1),n._parseProfileTierLevel(r,i,t),r.readUEG();var s=t.chromaFormatIdc=r.readUEG(),o=420;s<=3&&(o=[0,420,422,444][s]);var u=0;s===3&&(u=r.readBits(1));var l=r.readUEG(),f=r.readUEG(),c=r.readBits(1),v,d,g,A;if(c===1&&(v=r.readUEG(),d=r.readUEG(),g=r.readUEG(),A=r.readUEG()),t.bitDepthLumaMinus8=r.readUEG(),t.bitDepthChromaMinus8=r.readUEG(),c===1){var p=(s===1||s===2)&&u===0?2:1,m=s===1&&u===0?2:1;l-=p*(d+v),f-=m*(A+g)}return{codec:"hev1.1.6.L93.B0",width:l,height:f,chromaFormat:o,hvcC:t}}},{key:"_parseProfileTierLevel",value:function(e,t,r){var i=r.generalTierFlag||0;r.generalProfileSpace=e.readBits(2),r.generalTierFlag=Math.max(e.readBits(1),i),r.generalProfileIdc=Math.max(e.readBits(5),r.generalProfileIdc||0),r.generalProfileCompatibilityFlags=e.readBits(32),r.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];var s=e.readBits(8);i<r.generalTierFlag?r.generalLevelIdc=s:r.generalLevelIdc=Math.max(s,r.generalLevelIdc||0);var o=[],u=[];if(t>e.bitsAvailable)throw new Error("maxSubLayersMinus inavlid size ".concat(t));for(var l=0;l<t;l++)o[l]=e.readBits(1),u[l]=e.readBits(1);t>0&&e.readBits((8-t)*2);for(var f=0;f<t;f++)o[f]!==0&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),u[f]!==0&&e.readBits(8)}}]),n}(),wt=9e4/2,Fe=3,oe=9e4,De=5*9e4,Se=9e4,At=9e4/2,Dt=9e4*5,St=function(){function n(a,e,t,r){M(this,n),this.videoTrack=a,this.audioTrack=e,this.metadataTrack=t,this._baseDts=-1,this._baseVideoDts=-1,this._baseAudioDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=!1,this._videoTimestampBreak=!1,this._lastAudioExceptionGapDot=0,this._lastAudioExceptionOverlapDot=0,this._lastAudioExceptionLargeGapDot=0,this._needForceFixLargeGap=r==null?void 0:r.forceFixLargeGap,this._largeGapThreshold=(r==null?void 0:r.largeGapThreshold)||Dt}return R(n,[{key:"fix",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;t=Math.round(t*9e4);var s=this.videoTrack,o=this.audioTrack,u=s.samples,l=o.samples;if(!(!u.length&&!l.length)){var f=u[0],c=l[0],v=0;if(u.length&&l.length&&(v=f.dts-c.pts),this._baseDtsInited||this._calculateBaseDts(this.audioTrack,this.videoTrack),r&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t,this._baseAudioDts-=t,this._baseVideoDts-=t),!i){this._videoNextDts=v>0?t+v:t,this._audioNextPts=v>0?t:t-v,this._needForceFixLargeGap&&(this._videoNextDts=0,this._audioNextPts=0);var d=f?f.dts-this._baseDts-this._videoNextDts:0,g=c?c.pts-this._baseDts-this._audioNextPts:0;Math.abs(d||g)>Se&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=t)}if(this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(o),this._fixVideo(s),this.metadataTrack.exist()){var A=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach(function(p){p.pts=p.originPts-e._baseDts,p.time=Math.max(0,p.pts)/A})}s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].dts),o.samples.length&&(o.baseMediaDecodeTime=o.samples[0].pts*o.timescale/9e4)}}},{key:"_fixVideo",value:function(e){var t=this,r=e.samples;if(r.length){if(r.forEach(function(D){D.dts-=t._needForceFixLargeGap?t._baseVideoDts:t._baseDts,D.pts-=t._needForceFixLargeGap?t._baseVideoDts:t._baseDts}),this._videoNextDts===void 0){var i=r[0];this._videoNextDts=i.dts}var s=r.length,o=0,u=r[0],l=r[1],f=this._videoNextDts-u.dts;if(Math.abs(f)>At){var c;if(e.warnings.push({type:ne.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts/90,firstSampleDts:u.dts/90,nextSampleDts:(((c=r[1])===null||c===void 0?void 0:c.dts)||0)/90,sampleDuration:f/90}),u.dts+=f,u.pts+=f,l&&Math.abs(l.dts-u.dts)>Se)this._videoTimestampBreak=!0,r.forEach(function(D,k){k!==0&&(D.dts+=f,D.pts+=f)});else for(var v=1;v<s-1;v++){var d,g=(d=r[v])===null||d===void 0?void 0:d.dts,A=r[v-1].dts;g&&g-A<0&&(r[v].dts+=f,r[v].pts+=f)}}var p;if(e.fpsNum&&e.fpsDen&&(p=e.timescale*(e.fpsDen/e.fpsNum)),p<90*10&&(p=0),!p){var m=e.samples[0],U=e.samples[1];p=s===1?9e3:Math.floor(U.dts-m.dts)}for(var y=0;y<s;y++){var S=r[y].dts,w=r[y+1];if(y<s-1?o=w.dts-S:r[y-1]?o=Math.min(S-r[y-1].dts,p):o=p,o>Se||o<0){this._videoTimestampBreak=!0,o=this._audioTimestampBreak?p:Math.max(o,30*90);var B=this._audioNextPts||0;w&&w.dts>B&&(o=p),e.warnings.push({type:ne.LARGE_VIDEO_GAP,time:S/e.timescale,dts:S,originDts:r[y].originDts,nextDts:this._videoNextDts,sampleDuration:o,refSampleDuration:p})}r[y].duration=o,this._videoNextDts+=o}}}},{key:"_fixAudio",value:function(e){var t=this,r=e.samples;r.length&&(r.forEach(function(i){i.pts-=t._needForceFixLargeGap?t._baseAudioDts:t._baseDts,i.dts=i.pts}),this._doFixAudioInternal(e,r,9e4))}},{key:"_calculateBaseDts",value:function(e,t){var r=e.samples,i=t.samples;if(!r.length&&!i.length)return!1;var s=1/0,o=1/0;r.length&&(e.baseDts=s=r[0].pts,this._baseAudioDts=s),i.length&&(t.baseDts=o=i[0].dts,this._baseVideoDts=o),this._baseDts=Math.min(s,o);var u=o-s,l=!1;return Number.isFinite(u)&&Math.abs(u)>wt&&t.warnings.push({type:ne.LARGE_AV_SHIFT,videoBaseDts:o,audioBasePts:s,baseDts:this._baseDts,delta:u}),Number.isFinite(u)&&Math.abs(u)>this._largeGapThreshold*oe&&(l=!0),this._baseDtsInited||(l&&this._needForceFixLargeGap?this._needForceFixLargeGap=!0:this._needForceFixLargeGap=!1),this._baseDtsInited=!0,!0}},{key:"_resetBaseDtsWhenStreamBreaked",value:function(){if(this._baseDtsInited&&this._videoTimestampBreak&&this._audioTimestampBreak){var e=this._calculateBaseDts(this.audioTrack,this.videoTrack);if(!e)return;this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts),this._audioLastSample=null,this._videoLastSample=null,this._videoTimestampBreak=!1,this._audioTimestampBreak=!1}}},{key:"_doFixAudioInternal",value:function(e,t,r){e.sampleDuration||(e.sampleDuration=X.getFrameDuration(e.timescale,r));var i=e.sampleDuration;if(this._audioNextPts===void 0){var s=t[0];this._audioNextPts=s.pts}for(var o=0;o<t.length;o++){var u=this._audioNextPts,l=t[o],f=l.pts-u;if(!this._audioTimestampBreak&&f>=Fe*i&&f<=oe&&!ct){var c=X.getSilentFrame(e.codec,e.channelCount)||t[0].data.subarray(),v=Math.floor(f/i);Math.abs(l.pts-this._lastAudioExceptionGapDot)>De&&(this._lastAudioExceptionGapDot=l.pts),e.warnings.push({type:ne.AUDIO_FILLED,pts:l.pts/90,originPts:l.originPts,count:v,nextPts:u/90,refSampleDuration:i});for(var d=0;d<v;d++){var g=new ae(Math.floor(u),c);g.originPts=Math.floor(this._baseDts+u),t.splice(o,0,g),this._audioNextPts+=i,o++}o--}else f<=-Fe*i&&f>=-1*oe?(Math.abs(l.pts-this._lastAudioExceptionOverlapDot)>De&&(this._lastAudioExceptionOverlapDot=l.pts,e.warnings.push({type:ne.AUDIO_DROPPED,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,refSampleDuration:i})),t.splice(o,1),o--):(Math.abs(f)>=oe&&(this._audioTimestampBreak=!0,Math.abs(l.pts-this._lastAudioExceptionLargeGapDot)>De&&(this._lastAudioExceptionLargeGapDot=l.pts,e.warnings.push({type:ne.LARGE_AUDIO_GAP,time:l.pts/1e3,pts:l.pts/90,originPts:l.originPts,nextPts:u/90,sampleDuration:f,refSampleDuration:i}))),l.dts=l.pts=u,this._audioNextPts+=i)}}}]),n}(),K=new Xe("TsDemuxer"),kt=function(){function n(a,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};M(this,n),h(this,"_pmtId",-1),h(this,"_remainingPacketData",null),h(this,"_videoPesData",[]),h(this,"_audioPesData",[]),h(this,"_gopId",0),this.videoTrack=a||new qe,this.audioTrack=e||new Ke,this.metadataTrack=t||new je,this._fixer=new St(this.videoTrack,this.audioTrack,this.metadataTrack,r)}return R(n,[{key:"demux",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.audioTrack,s=this.videoTrack,o=this.metadataTrack;t&&(this._pmtId=-1,s.reset(),i.reset(),o.reset()),!r||t?(this._remainingPacketData=null,this._videoPesData=[],this._audioPesData=[]):(s.samples=[],i.samples=[],o.seiSamples=[],s.warnings=[],i.warnings=[],this._remainingPacketData&&(e=H(this._remainingPacketData,e),this._remainingPacketData=null));var u=e.length,l=u%188;l&&(this._remainingPacketData=e.subarray(u-l),u-=l);for(var f=s.pid,c=i.pid,v=0;v<u;v+=188){if(e[v]!==71)throw new Error("TS packet did not start with 0x47");var d=!!(e[v+1]&64),g=((e[v+1]&31)<<8)+e[v+2],A=(e[v+3]&48)>>4,p=void 0;if(A>1){if(p=v+5+e[v+4],p===v+188)continue}else p=v+4;switch(g){case 0:d&&(p+=e[p]+1),this._pmtId=(e[p+10]&31)<<8|e[p+11];break;case this._pmtId:{d&&(p+=e[p]+1);var m=p+3+((e[p+1]&15)<<8|e[p+2])-4,U=(e[p+10]&15)<<8|e[p+11];for(p+=12+U;p<m;){var y=(e[p+1]&31)<<8|e[p+2];switch(e[p]){case 15:i.pid=c=y;break;case 27:if(f!==-1)break;s.codecType=$.AVC,s.pid=f=y;break;case 36:if(f!==-1)break;s.codecType=$.HEVC,s.pid=f=y;break;default:K.warn("Unsupported stream. type: ".concat(e[p],", pid: ").concat(y))}p+=((e[p+3]&15)<<8|e[p+4])+5}}break;case f:d&&this._videoPesData.length&&this._parseVideoData(),this._videoPesData.push(e.subarray(p,v+188));break;case c:d&&this._audioPesData.length&&this._parseAudioData(),this._audioPesData.push(e.subarray(p,v+188));break;case 17:case 8191:break;default:K.warn("Unknown pid: ".concat(g))}}return this._parseVideoData(),this._parseAudioData(),i.formatTimescale=s.formatTimescale=s.timescale=o.timescale=9e4,i.timescale=i.sampleRate||0,{videoTrack:s,audioTrack:i,metadataTrack:o}}},{key:"fix",value:function(e,t,r){return this._fixer.fix(e,t,r),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}},{key:"demuxAndFix",value:function(e,t,r,i){return this.demux(e,t,r),this.fix(i,t,r)}},{key:"_parseVideoData",value:function(){if(this._videoPesData.length){var e=n._parsePES(H.apply(void 0,N(this._videoPesData)));if(!e){K.warn("Cannot parse video pes",this._videoPesData);return}var t=J.parseAnnexB(e.data);t?this._createVideoSample(t,e.pts,e.dts):K.warn("Cannot parse avc units",e),this._videoPesData=[]}}},{key:"_createVideoSample",value:function(e,t,r){var i=this;if(e.length){var s=this.videoTrack,o=s.codecType===$.HEVC,u=new Be(t,r);e.forEach(function(l){var f=o?l[0]>>>1&63:l[0]&31;switch(f){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(!o&&f!==5||o&&f===5)break;u.setToKeyframe(),i._gopId++;break;case 6:case 39:case 40:if(!o&&f!==6||o&&f===6)break;i.metadataTrack.seiSamples.push(new ht(J.parseSEI(J.removeEPB(l),o),t));return;case 32:if(!o)break;if(!s.vps.length){var c=ze.parseVPS(J.removeEPB(l),s.hvcC);s.hvcC=s.hvcC||c,s.vps=[l]}break;case 7:case 33:if(!o&&f!==7||o&&f===7)break;if(!s.sps.length){var v=J.removeEPB(l),d=o?ze.parseSPS(v,s.hvcC):bt.parseSPS(v);s.sps=[l],s.hvcC=s.hvcC||d.hvcC,s.codec=d.codec,s.width=d.width,s.height=d.height,s.sarRatio=d.sarRatio,s.fpsNum=d.fpsNum,s.fpsDen=d.fpsDen}break;case 8:case 34:if(!o&&f!==8||o&&f===8)break;s.pps.length||(s.pps=[l]);break;case 9:case 35:break;case 38:if(o){for(var g=!1,A=2;A<l.byteLength;A++)if(l[A]===255){g=!0;break}if(!g)return}break}u.units.push(l)}),u.gopId=this._gopId,this._pushVideoSample(s,u)}}},{key:"_pushVideoSample",value:function(e,t){if(t.units.length)if(t.pts===null||t.pts===void 0){K.warn("Video sample no pts",t);var r=e.samples[e.samples.length-1];r?(t.pts=r.pts,t.dts=r.dts):K.warn("Drop video sample",t)}else e.samples.push(t)}},{key:"_parseAudioData",value:function(){if(this._audioPesData.length){var e=n._parsePES(H.apply(void 0,N(this._audioPesData)));if(!e){K.warn("Cannot parse audio pes",this._audioPesData);return}this._parseAacData(e),this._audioPesData=[]}}},{key:"_parseAacData",value:function(e){var t=this.audioTrack,r=e.pts;if(r==null){if(K.warn("AAC pes not pts",t),!t.samples.length||!t.sampleRate)return;r=t.samples[t.samples.length-1].pts+X.getFrameDuration(t.sampleRate)}var i=X.parseADTS(e.data,r);if(i){var s;t.codec=i.codec,t.channelCount=i.channelCount,t.sampleRate=i.sampleRate,t.objectType=i.objectType,t.sampleRateIndex=i.samplingFrequencyIndex,t.config=i.config,(s=t.samples).push.apply(s,N(i.frames.map(function(o){return new ae(o.pts,o.data)}))),i.skip&&K.warn("Skip aac adts ".concat(i.skip," bits")),i.remaining&&K.warn("Remaining aac adts ".concat(i.remaining," bits"))}else K.warn("Cannot parse aac adts",e)}}],[{key:"probe",value:function(e){return e.length?e[0]===71&&e[188]===71&&e[376]===71:!1}},{key:"_parsePES",value:function(e){var t=e[8];if(!(t==null||e.length<t+9)){var r=e[0]<<16|e[1]<<8|e[2];if(r===1){var i=(e[4]<<8)+e[5];if(!(i&&i>e.length-6)){var s,o,u=e[7];return u&192&&(s=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,u&64?(o=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,s-o>60*9e4&&(s=o)):o=s),{data:e.subarray(9+t),pts:s,dts:o}}}}}}]),n}(),xe=function(){function n(a,e,t){M(this,n),this.dv=new DataView(a),this.start=this.offset=e||this.dv.byteOffset,this.end=t?this.start+t:this.start+this.dv.byteLength}return R(n,[{key:"buffer",get:function(){return this.dv.buffer}},{key:"unreadLength",get:function(){return Math.max(this.end-this.offset,0)}},{key:"size",get:function(){return this.end-this.start}},{key:"readFloat",value:function(e){var t=0;switch(e){case 4:t=this.dv.getFloat32(this.offset);break;case 8:t=this.dv.getFloat64(this.offset);break;default:throw new Error("read ".concat(e,"-byte float is not supported"))}return this.offset+=e,t}},{key:"back",value:function(e){this.offset-=e}},{key:"skip",value:function(e){this.offset+=e}},{key:"readInt",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getInt8(t);case 2:return this.dv.getInt16(t);case 4:return this.dv.getInt32(t);default:throw new Error("read ".concat(e,"-byte integers is not supported"))}}},{key:"read",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getUint8(t);case 2:return this.dv.getUint16(t);case 3:return(this.dv.getUint16(t)<<8)+this.dv.getUint8(t+2);case 4:return this.dv.getUint32(t);default:return this.back(e-4),this.read(e-4)+this.dv.getUint32(t)*Math.pow(256,e-4)}}},{key:"write",value:function(e,t){var r=this.offset;switch(this.offset+=e,e){case 1:return this.dv.setUint8(r,t);case 2:return this.dv.setUint16(r,t);case 3:return this.dv.setUint8(r,t>>>16),this.dv.setUint16(r+1,65535&t);case 4:return this.dv.setUint32(r,t);default:throw new Error("write ".concat(e,"-byte integers is not supported"))}}},{key:"readToBuffer",value:function(e){var t;return this.offset||e?t=this.dv.buffer.slice(this.offset,e?this.offset+e:this.end):t=this.dv.buffer,this.offset+=t.byteLength,t}},{key:"readToUint8",value:function(e){var t=new Uint8Array(this.dv.buffer,this.offset,e||this.unreadLength);return this.offset+=t.byteLength,t}},{key:"readString",value:function(e){for(var t=0,r="";t<e;t++)r+=String.fromCharCode(this.dv.getUint8(this.offset)),this.offset++;return r}}],[{key:"fromUint8",value:function(e){return new n(e.buffer,e.byteOffset,e.byteLength)}},{key:"concatUint8s",value:function(e){var t=new Uint8Array(e.reduce(function(i,s){return i+s.byteLength},0)),r=0;return e.forEach(function(i){t.set(i,r),r+=i.byteLength}),t}},{key:"concatUint8",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.concatUint8s(t)}}]),n}(),xt=function(){function n(a,e){M(this,n),this.offset=0,this.val=a,this.size=e}return R(n,[{key:"skip",value:function(e){this.offset+=e}},{key:"read",value:function(e){var t=this.size-this.offset-e;if(t>=0){var r=0,i=0;if(this.offset+=e,this.size>31){for(;i<e;i++)r+=Math.pow(2,i);return this.val/Math.pow(2,t)&r}else{for(;i<e;i++)r+=1<<i;return this.val>>>t&r}}throw new Error("the number of the read operation exceeds the total length limit of bits")}}],[{key:"fromByte",value:function(e,t){return new n(e.read(t),t<<3)}}]),n}(),O=function(){function n(){M(this,n)}return R(n,null,[{key:"findBox",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=[];if(!e)return i;for(var s=0,o="",u=0;e.length>7;){if(s=b(e),o=String.fromCharCode.apply(null,e.subarray(4,8)),u=8,s===1?(s=re(e,8),u+=8):s||(s=e.length),!t[0]||o===t[0]){var l=e.subarray(0,s);if(t.length<2)i.push({start:r,size:s,headerSize:u,type:o,data:l});else return n.findBox(l.subarray(u),t.slice(1),r+u)}r+=s,e=e.subarray(s)}return i}},{key:"tfhd",value:function(e){return E(e,!0,function(t,r){t.trackId=b(r);var i=4,s=t.flags&255&1,o=t.flags&255&2,u=t.flags&255&8,l=t.flags&255&16,f=t.flags&255&32;s&&(i+=4,t.baseDataOffset=b(r,i),i+=4),o&&(t.sampleDescriptionIndex=b(r,i),i+=4),u&&(t.defaultSampleDuration=b(r,i),i+=4),l&&(t.defaultSampleSize=b(r,i),i+=4),f&&(t.defaultSampleFlags=b(r,i))})}},{key:"sidx",value:function(e){return E(e,!0,function(t,r){var i=0;t.reference_ID=b(r,i),i+=4,t.timescale=b(r,i),i+=4,t.version===0?(t.earliest_presentation_time=b(r,i),i+=4,t.first_offset=b(r,i),i+=4):(t.earliest_presentation_time=re(r,i),i+=8,t.first_offset=re(r,i),i+=8),i+=2,t.references=[];var s=P(r,i);i+=2;for(var o=0;o<s;o++){var u={};t.references.push(u);var l=b(r,i);i+=4,u.reference_type=l>>31&1,u.referenced_size=l&2147483647,u.subsegment_duration=b(r,i),i+=4,l=b(r,i),i+=4,u.starts_with_SAP=l>>31&1,u.SAP_type=l>>28&7,u.SAP_delta_time=l&268435455}})}},{key:"moov",value:function(e){return E(e,!1,function(t,r,i){t.mvhd=n.mvhd(n.findBox(r,["mvhd"],i)[0]),t.trak=n.findBox(r,["trak"],i).map(function(s){return n.trak(s)}),t.pssh=n.pssh(n.findBox(r,["pssh"],i)[0])})}},{key:"mvhd",value:function(e){return E(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=b(r,16),t.duration=re(r,20),i+=28):(t.timescale=b(r,8),t.duration=b(r,12),i+=16),t.nextTrackId=b(r,i+76)})}},{key:"trak",value:function(e){return E(e,!1,function(t,r,i){t.tkhd=n.tkhd(n.findBox(r,["tkhd"],i)[0]),t.mdia=n.mdia(n.findBox(r,["mdia"],i)[0])})}},{key:"tkhd",value:function(e){return E(e,!0,function(t,r){var i=xe.fromUint8(r);t.version===1?(i.read(8),i.read(8),t.trackId=i.read(4),i.read(4),t.duration=i.read(8)):(i.read(4),i.read(4),t.trackId=i.read(4),i.read(4),t.duration=i.read(4)),i.skip(16),t.matrix=[];for(var s=0;s<36;s++)t.matrix.push(i.read(1));i.back(36);for(var o=[],u=0,l;u<3;u++)o.push(Ae(i.readInt(2),i.readInt(2))),o.push(Ae(i.readInt(2),i.readInt(2))),l=i.readInt(4),o.push(Ae(l>>30,l&1073741823));t.rotation=gt(o),t.width=i.read(4),t.height=i.read(4)})}},{key:"mdia",value:function(e){return E(e,!1,function(t,r,i){t.mdhd=n.mdhd(n.findBox(r,["mdhd"],i)[0]),t.hdlr=n.hdlr(n.findBox(r,["hdlr"],i)[0]),t.minf=n.minf(n.findBox(r,["minf"],i)[0])})}},{key:"mdhd",value:function(e){return E(e,!0,function(t,r){var i=0;t.version===1?(t.timescale=b(r,16),t.duration=re(r,20),i+=28):(t.timescale=b(r,8),t.duration=b(r,12),i+=16);var s=P(r,i);t.language=String.fromCharCode((s>>10&31)+96,(s>>5&31)+96,(s&31)+96)})}},{key:"hdlr",value:function(e){return E(e,!0,function(t,r){t.version===0&&(t.handlerType=String.fromCharCode.apply(null,r.subarray(4,8)))})}},{key:"minf",value:function(e){return E(e,!1,function(t,r,i){t.vmhd=n.vmhd(n.findBox(r,["vmhd"],i)[0]),t.smhd=n.smhd(n.findBox(r,["smhd"],i)[0]),t.stbl=n.stbl(n.findBox(r,["stbl"],i)[0])})}},{key:"vmhd",value:function(e){return E(e,!0,function(t,r){t.graphicsmode=P(r),t.opcolor=[P(r,2),P(r,4),P(r,6)]})}},{key:"smhd",value:function(e){return E(e,!0,function(t,r){t.balance=P(r)})}},{key:"stbl",value:function(e){return E(e,!1,function(t,r,i){var s,o,u;t.stsd=n.stsd(n.findBox(r,["stsd"],i)[0]),t.stts=n.stts(n.findBox(r,["stts"],i)[0]),t.ctts=n.ctts(n.findBox(r,["ctts"],i)[0]),t.stsc=n.stsc(n.findBox(r,["stsc"],i)[0]),t.stsz=n.stsz(n.findBox(r,["stsz"],i)[0]),t.stco=n.stco(n.findBox(r,["stco"],i)[0]),t.stco||(t.co64=n.co64(n.findBox(r,["co64"],i)[0]),t.stco=t.co64);var l=(s=t.stsd.entries[0])===null||s===void 0||(o=s.sinf)===null||o===void 0||(u=o.schi)===null||u===void 0?void 0:u.tenc.default_IV_size;t.stss=n.stss(n.findBox(r,["stss"],i)[0]),t.senc=n.senc(n.findBox(r,["senc"],i)[0],l)})}},{key:"senc",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;return E(e,!0,function(r,i){var s=0,o=b(i,s);s+=4,r.samples=[];for(var u=0;u<o;u++){var l={};l.InitializationVector=[];for(var f=0;f<t;f++)l.InitializationVector[f]=i[s+f];if(s+=t,r.flags&2){l.subsamples=[];var c=P(i,s);s+=2;for(var v=0;v<c;v++){var d={};d.BytesOfClearData=P(i,s),s+=2,d.BytesOfProtectedData=b(i,s),s+=4,l.subsamples.push(d)}}r.samples.push(l)}})}},{key:"pssh",value:function(e){return E(e,!0,function(t,r){for(var i=[],s=[],o=0,u=0;u<16;u++)s.push(_e(r[o+u]));if(o+=16,t.version>0){var l=b(r,o);o+=4;for(var f=0;f<(""+l).length;f++)for(var c=0;c<16;c++){var v=r[o];o+=1,i.push(_e(v))}}var d=b(r,o);t.data_size=d,o+=4,t.kid=i,t.system_id=s,t.buffer=r})}},{key:"stsd",value:function(e){return E(e,!0,function(t,r,i){t.entryCount=b(r),t.entries=n.findBox(r.subarray(4),[],i+4).map(function(s){switch(s.type){case"av01":return n.av01(s);case"avc1":case"avc2":case"avc3":case"avc4":return n.avc1(s);case"hvc1":case"hev1":return n.hvc1(s);case"mp4a":return n.mp4a(s);case"alaw":case"ulaw":return n.alaw(s);case"enca":return E(s,!1,function(o,u,l){o.channelCount=P(u,16),o.samplesize=P(u,18),o.sampleRate=b(u,24)/65536,u=u.subarray(28),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.esds=n.esds(n.findBox(u,["esds"],l)[0])});case"encv":return E(s,!1,function(o,u,l){o.width=P(u,24),o.height=P(u,26),o.horizresolution=b(u,28),o.vertresolution=b(u,32),u=u.subarray(78),o.sinf=n.sinf(n.findBox(u,["sinf"],l)[0]),o.avcC=n.avcC(n.findBox(u,["avcC"],l)[0]),o.hvcC=n.hvcC(n.findBox(u,["hvcC"],l)[0]),o.pasp=n.pasp(n.findBox(u,["pasp"],l)[0])})}}).filter(Boolean)})}},{key:"tenc",value:function(e){return E(e,!1,function(t,r){var i=6;t.default_IsEncrypted=r[i],i+=1,t.default_IV_size=r[i],i+=1,t.default_KID=[];for(var s=0;s<16;s++)t.default_KID.push(_e(r[i])),i+=1})}},{key:"schi",value:function(e){return E(e,!1,function(t,r,i){t.tenc=n.tenc(n.findBox(r,["tenc"],i)[0])})}},{key:"sinf",value:function(e){return E(e,!1,function(t,r,i){t.schi=n.schi(n.findBox(r,["schi"],i)[0]),t.frma=n.frma(n.findBox(r,["frma"],i)[0])})}},{key:"frma",value:function(e){return E(e,!1,function(t,r){t.data_format="";for(var i=0;i<4;i++)t.data_format+=String.fromCharCode(r[i])})}},{key:"colr",value:function(e){return E(e,!1,function(t,r){var i=xe.fromUint8(r);t.data=e.data,t.colorType=i.readString(4),t.colorType==="nclx"?(t.colorPrimaries=i.read(2),t.transferCharacteristics=i.read(2),t.matrixCoefficients=i.read(2),t.fullRangeFlag=i.read(1)>>7):(t.colorType==="rICC"||t.colorType==="prof")&&(t.iccProfile=r.readToUint8())})}},{key:"av01",value:function(e){return E(e,!1,function(t,r,i){var s=Ee(t,r),o=r.subarray(s);i+=s,t.av1C=n.av1C(n.findBox(o,["av1C"],i)[0]),t.colr=n.colr(n.findBox(o,["colr"],i)[0])})}},{key:"av1C",value:function(e){return E(e,!1,function(t,r){t.data=e.data;var i=xe.fromUint8(r),s=xt.fromByte(i,4);t.marker=s.read(1),t.version=s.read(7),t.seqProfile=s.read(3),t.seqLevelIdx0=s.read(5),t.seqTier0=s.read(1),t.highBitdepth=s.read(1),t.twelveBit=s.read(1),t.monochrome=s.read(1),t.chromaSubsamplingX=s.read(1),t.chromaSubsamplingY=s.read(1),t.chromaSamplePosition=s.read(2),t.reserved=s.read(3),t.initialPresentationDelayPresent=s.read(1),t.initialPresentationDelayPresent?t.initialPresentationDelayMinusOne=s.read(4):t.initialPresentationDelayMinusOne=0,t.configOBUs=i.readToUint8();var o;t.seqLevelIdx0===2&&t.highBitdepth===1?o=t.twelveBit===1?"12":"10":t.seqProfile<=2&&(o=t.highBitdepth===1?"10":"08"),t.codec=["av01",t.seqProfile,(t.seqLevelIdx0<10?"0"+t.seqLevelIdx0:t.seqLevelIdx0)+(t.seqTier0?"H":"M"),o].join(".")})}},{key:"avc1",value:function(e){return E(e,!1,function(t,r,i){var s=Ee(t,r),o=r.subarray(s);i+=s,t.avcC=n.avcC(n.findBox(o,["avcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"avcC",value:function(e){return E(e,!1,function(t,r){t.data=e.data,t.configurationVersion=r[0],t.AVCProfileIndication=r[1],t.profileCompatibility=r[2],t.AVCLevelIndication=r[3],t.codec=Ze([r[1],r[2],r[3]]),t.lengthSizeMinusOne=r[4]&3,t.spsLength=r[5]&31,t.sps=[];for(var i=6,s=0;s<t.spsLength;s++){var o=P(r,i);i+=2,t.sps.push(r.subarray(i,i+o)),i+=o}t.ppsLength=r[i],i+=1,t.pps=[];for(var u=0;u<t.ppsLength;u++){var l=P(r,i);i+=2,t.pps.push(r.subarray(i,i+=l)),i+=l}})}},{key:"hvc1",value:function(e){return E(e,!1,function(t,r,i){var s=Ee(t,r),o=r.subarray(s);i+=s,t.hvcC=n.hvcC(n.findBox(o,["hvcC"],i)[0]),t.pasp=n.pasp(n.findBox(o,["pasp"],i)[0])})}},{key:"hvcC",value:function(e){return E(e,!1,function(t,r){t.data=e.data,t.codec="hev1.1.6.L93.B0",t.configurationVersion=r[0];var i=r[1];t.generalProfileSpace=i>>6,t.generalTierFlag=(i&32)>>5,t.generalProfileIdc=i&31,t.generalProfileCompatibility=b(r,2),t.generalConstraintIndicatorFlags=r.subarray(6,12),t.generalLevelIdc=r[12],t.avgFrameRate=P(r,19),t.numOfArrays=r[22],t.vps=[],t.sps=[],t.pps=[];for(var s=23,o=0,u=0,l=0,f=0;f<t.numOfArrays;f++){o=r[s]&63,u=P(r,s+1),s+=3;for(var c=[],v=0;v<u;v++)l=P(r,s),s+=2,c.push(r.subarray(s,s+l)),s+=l;if(o===32){var d;(d=t.vps).push.apply(d,c)}else if(o===33){var g;(g=t.sps).push.apply(g,c)}else if(o===34){var A;(A=t.pps).push.apply(A,c)}}})}},{key:"pasp",value:function(e){return E(e,!1,function(t,r){t.hSpacing=b(r),t.vSpacing=b(r,4)})}},{key:"mp4a",value:function(e){return E(e,!1,function(t,r,i){var s=Ne(t,r);t.esds=n.esds(n.findBox(r.subarray(s),["esds"],i+s)[0])})}},{key:"esds",value:function(e){return E(e,!0,function(t,r){t.codec="mp4a.";for(var i=0,s=0,o=0,u=0;r.length;){for(i=0,u=r[i],s=r[i+1],i+=2;s&128;)o=(s&127)<<7,s=r[i],i+=1;if(o+=s&127,u===3)r=r.subarray(i+3);else if(u===4)t.codec+=(r[i].toString(16)+".").padStart(3,"0"),r=r.subarray(i+13);else if(u===5){var l=t.config=r.subarray(i,i+o),f=(l[0]&248)>>3;f===31&&l.length>=2&&(f=32+((l[0]&7)<<3)+((l[1]&224)>>5)),t.objectType=f,t.codec+=f.toString(16),t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}else{t.codec[t.codec.length-1]==="."&&(t.codec=t.codec.substring(0,t.codec.length-1));return}}})}},{key:"alaw",value:function(e){return E(e,!1,function(t,r){Ne(t,r)})}},{key:"stts",value:function(e){return E(e,!0,function(t,r){for(var i=b(r),s=[],o=4,u=0;u<i;u++)s.push({count:b(r,o),delta:b(r,o+4)}),o+=8;t.entryCount=i,t.entries=s})}},{key:"ctts",value:function(e){return E(e,!0,function(t,r){var i=b(r),s=[],o=4;if(t.version===1)for(var u=0;u<i;u++)s.push({count:b(r,o),offset:b(r,o+4)}),o+=8;else for(var l=0;l<i;l++)s.push({count:b(r,o),offset:-(~b(r,o+4)+1)}),o+=8;t.entryCount=i,t.entries=s})}},{key:"stsc",value:function(e){return E(e,!0,function(t,r){for(var i=b(r),s=[],o=4,u=0;u<i;u++)s.push({firstChunk:b(r,o),samplesPerChunk:b(r,o+4),sampleDescriptionIndex:b(r,o+8)}),o+=12;t.entryCount=i,t.entries=s})}},{key:"stsz",value:function(e){return E(e,!0,function(t,r){var i=b(r),s=b(r,4),o=[];if(!i)for(var u=8,l=0;l<s;l++)o.push(b(r,u)),u+=4;t.sampleSize=i,t.sampleCount=s,t.entrySizes=o})}},{key:"stco",value:function(e){return E(e,!0,function(t,r){for(var i=b(r),s=[],o=4,u=0;u<i;u++)s.push(b(r,o)),o+=4;t.entryCount=i,t.entries=s})}},{key:"co64",value:function(e){return E(e,!0,function(t,r){for(var i=b(r),s=[],o=4,u=0;u<i;u++)s.push(re(r,o)),o+=8;t.entryCount=i,t.entries=s})}},{key:"stss",value:function(e){return E(e,!0,function(t,r){for(var i=b(r),s=[],o=4,u=0;u<i;u++)s.push(b(r,o)),o+=4;t.entryCount=i,t.entries=s})}},{key:"moof",value:function(e){return E(e,!1,function(t,r,i){t.mfhd=n.mfhd(n.findBox(r,["mfhd"],i)[0]),t.traf=n.findBox(r,["traf"],i).map(function(s){return n.traf(s)})})}},{key:"mfhd",value:function(e){return E(e,!0,function(t,r){t.sequenceNumber=b(r)})}},{key:"traf",value:function(e){return E(e,!1,function(t,r,i){t.tfhd=n.tfhd(n.findBox(r,["tfhd"],i)[0]),t.tfdt=n.tfdt(n.findBox(r,["tfdt"],i)[0]),t.trun=n.trun(n.findBox(r,["trun"],i)[0])})}},{key:"trun",value:function(e){return E(e,!0,function(t,r){var i=t.version,s=t.flags,o=r.length,u=t.sampleCount=b(r),l=4;if(o>l&&s&1&&(t.dataOffset=-(~b(r,l)+1),l+=4),o>l&&s&4&&(t.firstSampleFlags=b(r,l),l+=4),t.samples=[],o>l)for(var f,c=0;c<u;c++)f={},s&256&&(f.duration=b(r,l),l+=4),s&512&&(f.size=b(r,l),l+=4),s&1024&&(f.flags=b(r,l),l+=4),s&2048&&(i?f.cts=-(~b(r,l+4)+1):f.cts=b(r,l),l+=4),t.samples.push(f)})}},{key:"tfdt",value:function(e){return E(e,!0,function(t,r){t.version===1?t.baseMediaDecodeTime=re(r):t.baseMediaDecodeTime=b(r)})}},{key:"probe",value:function(e){return!!n.findBox(e,["ftyp"])}},{key:"parseSampleFlags",value:function(e){return{isLeading:(e[0]&12)>>>2,dependsOn:e[0]&3,isDependedOn:(e[1]&192)>>>6,hasRedundancy:(e[1]&48)>>>4,paddingValue:(e[1]&14)>>>1,isNonSyncSample:e[1]&1,degradationPriority:e[2]<<8|e[3]}}},{key:"moovToTrack",value:function(e,t,r){var i,s,o=e.trak;if(!(!o||!o.length)){var u=o.find(function(we){var ee,te;return((ee=we.mdia)===null||ee===void 0||(te=ee.hdlr)===null||te===void 0?void 0:te.handlerType)==="vide"}),l=o.find(function(we){var ee,te;return((ee=we.mdia)===null||ee===void 0||(te=ee.hdlr)===null||te===void 0?void 0:te.handlerType)==="soun"});if(u&&t){var f,c,v,d,g,A,p,m=t,U=(f=u.tkhd)===null||f===void 0?void 0:f.trackId;U!=null&&(m.id=u.tkhd.trackId),m.tkhdDuration=u.tkhd.duration,m.mvhdDurtion=e.mvhd.duration,m.mvhdTimecale=e.mvhd.timescale,m.timescale=m.formatTimescale=u.mdia.mdhd.timescale,m.duration=u.mdia.mdhd.duration||m.mvhdDurtion/m.mvhdTimecale*m.timescale,m.rotation=u.tkhd.rotation,m.matrix=u.tkhd.matrix;var y=u.mdia.minf.stbl.stsd.entries[0];if(m.width=y.width,m.height=y.height,y.pasp&&(m.sarRatio=[y.pasp.hSpacing,y.pasp.vSpacing]),y.av1C)m.codecType=$.AV1,m.codec=y.av1C.codec,m.av1C=y.av1C.data,m.colr=y.colr.data;else if(y.hvcC)m.codecType=$.HEVC,m.codec=y.hvcC.codec,m.vps=y.hvcC.vps,m.sps=y.hvcC.sps,m.pps=y.hvcC.pps,m.hvcC=y.hvcC.data;else if(y.avcC)m.codec=y.avcC.codec,m.sps=y.avcC.sps,m.pps=y.avcC.pps;else throw new Error("unknown video stsd entry");if(m.present=!0,m.ext={},m.ext.stss=(c=u.mdia)===null||c===void 0||(v=c.minf)===null||v===void 0||(d=v.stbl)===null||d===void 0?void 0:d.stss,m.ext.ctts=(g=u.mdia)===null||g===void 0||(A=g.minf)===null||A===void 0||(p=A.stbl)===null||p===void 0?void 0:p.ctts,y&&y.type==="encv"){var S,w,B,D,k,C,I,V;m.isVideoEncryption=!0,y.default_KID=(S=y.sinf)===null||S===void 0||(w=S.schi)===null||w===void 0?void 0:w.tenc.default_KID,y.default_IsEncrypted=(B=y.sinf)===null||B===void 0||(D=B.schi)===null||D===void 0?void 0:D.tenc.default_IsEncrypted,y.default_IV_size=(k=y.sinf)===null||k===void 0||(C=k.schi)===null||C===void 0?void 0:C.tenc.default_IV_size,m.videoSenc=u.mdia.minf.stbl.senc&&u.mdia.minf.stbl.senc.samples,y.data_format=(I=y.sinf)===null||I===void 0||(V=I.frma)===null||V===void 0?void 0:V.data_format,m.useEME=e.useEME,m.kidValue=e.kidValue,m.pssh=e.pssh,m.encv=y}}if(l&&r){var z,q,Z,L,G,W,Y,j,se,x=r,Te=(z=l.tkhd)===null||z===void 0?void 0:z.trackId;Te!=null&&(x.id=l.tkhd.trackId),x.tkhdDuration=l.tkhd.duration,x.mvhdDurtion=e.mvhd.duration,x.mvhdTimecale=e.mvhd.timescale,x.timescale=x.formatTimescale=l.mdia.mdhd.timescale,x.duration=l.mdia.mdhd.duration||x.mvhdDurtion/x.mvhdTimecale*x.timescale;var T=l.mdia.minf.stbl.stsd.entries[0];switch(x.sampleSize=T.sampleSize,x.sampleRate=T.sampleRate,x.channelCount=T.channelCount,x.present=!0,T.type){case"alaw":x.codecType=x.codec=Q.G711PCMA,x.sampleRate=8e3;break;case"ulaw":x.codecType=x.codec=Q.G711PCMU,x.sampleRate=8e3;break;default:x.sampleDuration=X.getFrameDuration(x.sampleRate,x.timescale),x.sampleRateIndex=X.getRateIndexByRate(x.sampleRate),x.objectType=((i=T.esds)===null||i===void 0?void 0:i.objectType)||2,T.esds&&(x.config=Array.from(T.esds.config)),x.codec=((s=T.esds)===null||s===void 0?void 0:s.codec)||"mp4a.40.2";break}if(x.sampleDuration=X.getFrameDuration(x.sampleRate,x.timescale),x.objectType=((q=T.esds)===null||q===void 0?void 0:q.objectType)||2,T.esds&&T.esds.config&&(x.config=Array.from(T.esds.config)),x.codec=((Z=T.esds)===null||Z===void 0?void 0:Z.codec)||"mp4a.40.2",x.sampleRateIndex=X.getRateIndexByRate(x.sampleRate),x.ext={},x.ext.stss=(L=l.mdia)===null||L===void 0||(G=L.minf)===null||G===void 0||(W=G.stbl)===null||W===void 0?void 0:W.stss,x.ext.ctts=(Y=l.mdia)===null||Y===void 0||(j=Y.minf)===null||j===void 0||(se=j.stbl)===null||se===void 0?void 0:se.ctts,x.present=!0,T&&T.type==="enca"){var fe,ve,he,ce,de,pe,me,ye;x.isAudioEncryption=!0,T.data_format=(fe=T.sinf)===null||fe===void 0||(ve=fe.frma)===null||ve===void 0?void 0:ve.data_format,T.default_KID=(he=T.sinf)===null||he===void 0||(ce=he.schi)===null||ce===void 0?void 0:ce.tenc.default_KID,T.default_IsEncrypted=(de=T.sinf)===null||de===void 0||(pe=de.schi)===null||pe===void 0?void 0:pe.tenc.default_IsEncrypted,T.default_IV_size=(me=T.sinf)===null||me===void 0||(ye=me.schi)===null||ye===void 0?void 0:ye.tenc.default_IV_size,x.audioSenc=l.mdia.minf.stbl.senc&&l.mdia.minf.stbl.senc.samples,x.useEME=e.useEME,x.kidValue=e.kidValue,x.enca=T}}if(r&&(r.isVideoEncryption=t?t.isVideoEncryption:!1),t&&(t.isAudioEncryption=r?r.isAudioEncryption:!1),t!=null&&t.encv||r!=null&&r.enca){var ge,be,Me=t==null||(ge=t.encv)===null||ge===void 0?void 0:ge.default_KID,Re=r==null||(be=r.enca)===null||be===void 0?void 0:be.default_KID,Le=Me||Re?(Me||Re).join(""):null;t&&(t.kid=Le),r&&(r.kid=Le)}return t&&(t.flags=3841),r&&(r.flags=1793),{videoTrack:t,audioTrack:r}}}},{key:"evaluateDefaultDuration",value:function(e,t,r){var i,s=t==null||(i=t.samples)===null||i===void 0?void 0:i.length;if(!s)return 1024;var o=1024*s/t.timescale;return o*e.timescale/r}},{key:"moofToSamples",value:function(e,t,r){var i={};return e.mfhd&&(t&&(t.sequenceNumber=e.mfhd.sequenceNumber),r&&(r.sequenceNumber=e.mfhd.sequenceNumber)),e.traf.forEach(function(s){var o=s.tfhd,u=s.tfdt,l=s.trun;if(!(!o||!l)){u&&(t&&t.id===o.trackId&&(t.baseMediaDecodeTime=u.baseMediaDecodeTime),r&&r.id===o.trackId&&(r.baseMediaDecodeTime=u.baseMediaDecodeTime));var f=o.defaultSampleSize||0,c=o.defaultSampleDuration||n.evaluateDefaultDuration(t,r,l.samples.length||l.sampleCount),v=l.dataOffset||0,d=0,g=-1;if(!l.samples.length&&l.sampleCount){i[o.trackId]=[];for(var A=0;A<l.sampleCount;A++)i[o.trackId].push({offset:v,dts:d,duration:c,size:f}),d+=c,v+=f}else i[o.trackId]=l.samples.map(function(p,m){return p={offset:v,dts:d,pts:d+(p.cts||0),duration:p.duration||c,size:p.size||f,gopId:g,keyframe:m===0||p.flags!==null&&p.flags!==void 0&&(p.flags&65536)>>>0!==65536},p.keyframe&&(g++,p.gopId=g),d+=p.duration,v+=p.size,p})}}),i}},{key:"moovToSamples",value:function(e){var t=e.trak;if(!(!t||!t.length)){var r=t.find(function(I){var V,z;return((V=I.mdia)===null||V===void 0||(z=V.hdlr)===null||z===void 0?void 0:z.handlerType)==="vide"}),i=t.find(function(I){var V,z;return((V=I.mdia)===null||V===void 0||(z=V.hdlr)===null||z===void 0?void 0:z.handlerType)==="soun"});if(!(!r&&!i)){var s,o;if(r){var u,l,f=(u=r.mdia)===null||u===void 0||(l=u.minf)===null||l===void 0?void 0:l.stbl;if(!f)return;var c=f.stts,v=f.stsc,d=f.stsz,g=f.stco,A=f.stss,p=f.ctts;if(!c||!v||!d||!g||!A)return;s=Ge(c,v,d,g,p,A)}if(i){var m,U,y,S=(m=i.mdia)===null||m===void 0||(U=m.minf)===null||U===void 0?void 0:U.stbl;if(!S)return;var w=(y=i.mdia.mdhd)===null||y===void 0?void 0:y.timescale,B=S.stts,D=S.stsc,k=S.stsz,C=S.stco;if(!w||!B||!D||!k||!C)return;o=Ge(B,D,k,C)}return{videoSamples:s,audioSamples:o}}}}}]),n}();function Ge(n,a,e,t,r,i){var s=[],o=r==null?void 0:r.entries,u=a.entries,l=t.entries,f=e.entrySizes,c=i==null?void 0:i.entries,v;c&&(v={},c.forEach(function(D){v[D-1]=!0}));var d;o&&(d=[],o.forEach(function(D){for(var k=D.count,C=D.offset,I=0;I<k;I++)d.push(C)}));var g,A=-1,p=0,m=0,U=0,y=0,S=0,w=u[0].samplesPerChunk,B=u[1]?u[1].firstChunk-1:1/0;return n.entries.forEach(function(D){for(var k=D.count,C=D.delta,I=0;I<k;I++)g={dts:p,duration:C,size:f[m]||e.sampleSize,offset:l[U]+S,index:m},c&&(g.keyframe=v[m],g.keyframe&&A++,g.gopId=A),d&&m<d.length&&(g.pts=g.dts+d[m]),s.push(g),p+=C,m++,m<w?S+=g.size:(U++,S=0,U>=B&&(y++,B=u[y+1]?u[y+1].firstChunk-1:1/0),w+=u[y].samplesPerChunk)}),s}function Ee(n,a){return n.dataReferenceIndex=P(a,6),n.width=P(a,24),n.height=P(a,26),n.horizresolution=b(a,28),n.vertresolution=b(a,32),n.frameCount=P(a,40),n.depth=P(a,74),78}function Ne(n,a){return n.dataReferenceIndex=P(a,6),n.channelCount=P(a,16),n.sampleSize=P(a,18),n.sampleRate=b(a,24)/65536,28}function E(n,a,e){if(n){if(n.size!==n.data.length)throw new Error("box ".concat(n.type," size !== data.length"));var t={start:n.start,size:n.size,headerSize:n.headerSize,type:n.type};return a&&(t.version=n.data[n.headerSize],t.flags=yt(n.data,n.headerSize+1),t.headerSize+=4),e(t,n.data.subarray(t.headerSize),t.start+t.headerSize),t}}var Et=function(a,e,t){for(var r=String(t),i=e>>0,s=Math.ceil(i/r.length),o=[],u=String(a);s--;)o.push(r);return o.join("").substring(0,i-u.length)+u},_e=function(){for(var a=[],e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.forEach(function(i){a.push(Et(Number(i).toString(16),2,0))}),a[0]},Ut=function(){function n(a,e,t){M(this,n),h(this,"__loadedMoofWraps",[]),h(this,"__lastRemainData",null),h(this,"__lastRemainDataStart",0),h(this,"__nextMoofStart",-1),this.videoTrack=a||new qe,this.audioTrack=e||new Ke,this.metadataTrack=t||new je}return R(n,[{key:"demuxPart",value:function(e,t,r){var i=this,s=this.videoTrack,o=this.audioTrack,u=s.exist(),l=o.exist(),f=/av01/.test(s.codec);s.samples=[],o.samples=[];var c=e,v=t;if(this.__lastRemainData){var d=this.__lastRemainDataStart+this.__lastRemainData.byteLength,g=t<=d&&t>this.__lastRemainDataStart&&t+e.byteLength>d;if(g){var A=e.subarray(this.__lastRemainData.byteLength+this.__lastRemainDataStart-t);c=H(this.__lastRemainData,A),v=this.__lastRemainDataStart,this.__lastRemainData=null}else this.__lastRemainData=null,this.__lastRemainDataStart=0,this.__nextMoofStart=-1}if(!r){var p=O.findBox(c,["moov"])[0];if(!p)throw new Error("cannot found moov box");r=O.moov(p)}if(c){var m=v+c.byteLength;!u&&!l&&O.moovToTrack(r,s,o);var U=[];this.__nextMoofStart<0?O.findBox(c,["moof"],v).forEach(function(D){return U.push(D)}):this.__nextMoofStart>=v&&this.__nextMoofStart<=m-8&&O.findBox(c.subarray(this.__nextMoofStart-v),["moof"],this.__nextMoofStart).forEach(function(D){return U.push(D)}),U.filter(function(D){return D.size<=D.data.length}).forEach(function(D){var k=O.moof(D);i.__nextMoofStart=k.start+Math.max.apply(Math,N(k.traf.map(function(C){return C.trun.samples.reduce(function(I,V){return I+V.size},C.trun.dataOffset||0)}))),i.__loadedMoofWraps.push({start:k.start,nextMoofStart:i.__nextMoofStart,moof:k}),i.__loadedMoofWraps.sort(function(C,I){return C.start-I.start})});var y=lt(this.__loadedMoofWraps),S;try{var w=function(){var k=S.value;if(k.start>m||k.nextMoofStart<v)return"continue";var C=k.start,I=O.moofToSamples(k.moof,s,o),V=s.baseMediaDecodeTime,z=o.baseMediaDecodeTime,q;Object.keys(I).forEach(function(Z){s.id==Z?I[Z].some(function(L){var G=L.offset+=C;if(!(G<v)){if(G+L.size>m)return!0;var W=new Be((L.pts||L.dts)+V,L.dts+V);W.duration=L.duration,W.gopId=L.gopId,L.keyframe&&W.setToKeyframe();var Y=c.subarray(G-v,G-v+L.size);if(W.data=Y,!f)for(var j=0,se=Y.length-1;j<se;)q=b(Y,j),j+=4,W.units.push(Y.subarray(j,j+q)),j+=q;i.__lastRemainDataStart=G+L.size,s.samples.push(W)}}):o.id==Z&&I[Z].some(function(L){var G=L.offset+C;if(!(G<v)){if(G+L.size>m)return!0;var W=c.subarray(G-v,G-v+L.size);o.samples.push(new ae(L.dts+z,W,L.duration)),i.__lastRemainDataStart=G+L.size}})})};for(y.s();!(S=y.n()).done;)var B=w()}catch(D){y.e(D)}finally{y.f()}}return this.__lastRemainDataStart>v&&this.__lastRemainDataStart<c.byteLength+v?this.__lastRemainData=c.subarray(this.__lastRemainDataStart-v):(this.__lastRemainData=c,this.__lastRemainDataStart=v),s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].pts),o.samples.length&&(o.baseMediaDecodeTime=o.samples[0].pts),{videoTrack:s,audioTrack:o,metadataTrack:this.metadataTrack}}},{key:"demux",value:function(e,t){var r=this.videoTrack,i=this.audioTrack,s=r.exist(),o=i.exist();if(r.samples=[],i.samples=[],t){if(!o){var u=O.findBox(t,["moov"])[0];if(!u)throw new Error("cannot found moov box");O.moovToTrack(O.moov(u),null,i)}var l=O.findBox(t,["moof"])[0];if(l){var f=O.moofToSamples(O.moof(l),null,i)[i.id],c=i.baseMediaDecodeTime;if(f){var v=l.start;f.map(function(S){S.offset+=v;var w=t.subarray(S.offset,S.offset+S.size);i.samples.push(new ae(S.dts+c,w,S.duration))})}}}if(e){if(!s&&!o){var d=O.findBox(e,["moov"])[0];if(!d)throw new Error("cannot found moov box");O.moovToTrack(O.moov(d),r,i)}var g=O.findBox(e,["moof"])[0];if(g){var A=O.moofToSamples(O.moof(g),r,i),p=r.baseMediaDecodeTime,m=i.baseMediaDecodeTime,U=g.start,y;Object.keys(A).forEach(function(S){r.id==S?A[S].map(function(w){w.offset+=U;var B=new Be((w.pts||w.dts)+p,w.dts+p);B.duration=w.duration,B.gopId=w.gopId,w.keyframe&&B.setToKeyframe();var D=e.subarray(w.offset,w.offset+w.size);B.data=D;for(var k=0,C=D.length-1;k<C;)y=b(D,k),k+=4,B.units.push(D.subarray(k,k+y)),k+=y;r.samples.push(B)}):i.id==S&&A[S].map(function(w){w.offset+=U;var B=e.subarray(w.offset,w.offset+w.size);i.samples.push(new ae(w.dts+m,B,w.duration))})})}}return{videoTrack:r,audioTrack:i,metadataTrack:this.metadataTrack}}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}}],[{key:"probe",value:function(e){return O.probe(e)}}]),n}();function _t(n){for(var a=0,e=arguments.length,t=new Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];t.forEach(function(o){a+=o.length});var i=new n(a),s=0;return t.forEach(function(o){i.set(o,s),s+=o.length}),i}var F=function(){function n(){M(this,n),this.buffer=new Uint8Array(0)}return R(n,[{key:"write",value:function(){for(var e=this,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];r.forEach(function(s){s?e.buffer=_t(Uint8Array,e.buffer,s):window.console.warn(s)})}}],[{key:"writeUint16",value:function(e){return new Uint8Array([e>>8&255,e&255])}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,e&255])}}]),n}(),He=Math.pow(2,32)-1,_=function(){function n(){M(this,n)}return R(n,null,[{key:"box",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];r=r.filter(Boolean);var s=8+r.reduce(function(l,f){return l+f.byteLength},0),o=new Uint8Array(s);o[0]=s>>24&255,o[1]=s>>16&255,o[2]=s>>8&255,o[3]=s&255,o.set(e,4);var u=8;return r.forEach(function(l){o.set(l,u),u+=l.byteLength}),o}},{key:"ftyp",value:function(e){var t=e.find(function(r){return r.type===ie.VIDEO&&r.codecType===$.HEVC});return t?n.FTYPHEV1:n.FTYPAVC1}},{key:"initSegment",value:function(e){var t=n.ftyp(e),r=H(t,n.moov(e));return r}},{key:"pssh",value:function(e){var t=new Uint8Array([1,0,0,0].concat([16,119,239,236,192,178,77,2,172,227,60,30,82,226,251,75],[0,0,0,1],Oe(e.kid),[0,0,0,0]));return n.box(n.types.pssh,t)}},{key:"moov",value:function(e){if(e[0].useEME&&(e[0].encv||e[0].enca)){e[0].pssh||(e[0].pssh={kid:e[0].kid});var t=this.pssh(e[0].pssh);return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale),n.mvex(e)].concat(N(e.map(function(r){return n.trak(r)})),[t]))}else return n.box.apply(n,[n.types.moov,n.mvhd(e[0].mvhdDurtion||e[0].duration,e[0].mvhdTimecale||e[0].timescale)].concat(N(e.map(function(r){return n.trak(r)})),[n.mvex(e)]))}},{key:"mvhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]));return r}},{key:"trak",value:function(e){var t=n.box(n.types.trak,n.tkhd(e.id,e.tkhdDuration||0,e.width,e.height),n.mdia(e));return t}},{key:"tkhd",value:function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,s=n.box(n.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,e>>24&255,e>>16&255,e>>8&255,e&255,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,r&255,0,0,i>>8&255,i&255,0,0]));return s}},{key:"mdia",value:function(e){var t=n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minf(e));return t}},{key:"mdhd",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:9e4,r=n.box(n.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255,e>>24&255,e>>16&255,e>>8&255,e&255,85,196,0,0]));return r}},{key:"hdlr",value:function(e){var t=n.box(n.types.hdlr,n.HDLR_TYPES[e]);return t}},{key:"minf",value:function(e){var t=n.box(n.types.minf,e.type===ie.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stbl(e));return t}},{key:"stbl",value:function(e){var t=[];e&&e.ext&&e.ext.stss&&t.push(n.stss(e.ext.stss.entries));var r=n.box(n.types.stbl,n.stsd(e),n.STTS,t[0],n.STSC,n.STSZ,n.STCO);return r}},{key:"stsd",value:function(e){var t;e.type==="audio"?e.useEME&&e.enca?t=n.enca(e):e.codecType===Q.OPUS?t=n.opus(e):t=n.mp4a(e):e.useEME&&e.encv?t=n.encv(e):e.av1C?t=n.av01(e):t=n.avc1hev1(e);var r=n.box(n.types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),t);return r}},{key:"enca",value:function(e){var t=e.enca.channelCount,r=e.enca.sampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,r>>8&255,r&255,0,0]),s=n.esds(e.config),o=n.sinf(e.enca);return n.box(n.types.enca,i,s,o)}},{key:"encv",value:function(e){var t,r,i=e.sps.length>0?e.sps[0]:[],s=e.pps.length>0?e.pps[0]:[],o=e.width,u=e.height,l=e.sarRatio[0],f=e.sarRatio[1],c=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,o&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),v=new Uint8Array((t=(r=[1,i[1],i[2],i[3],255,225,i.length>>>8&255,i.length&255]).concat.apply(r,N(i)).concat([1,s.length>>>8&255,s.length&255])).concat.apply(t,N(s))),d=new Uint8Array([0,0,88,57,0,15,200,192,0,4,86,72]),g=n.sinf(e.encv),A=new Uint8Array([l>>24,l>>16&255,l>>8&255,l&255,f>>24,f>>16&255,f>>8&255,f&255]);return n.box(n.types.encv,c,n.box(n.types.avcC,v),n.box(n.types.btrt,d),g,n.box(n.types.pasp,A))}},{key:"schi",value:function(e){var t=new Uint8Array([]),r=n.tenc(e);return n.box(n.types.schi,t,r)}},{key:"tenc",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,e.default_IsEncrypted&255,e.default_IV_size&255].concat(Oe(e.default_KID)));return n.box(n.types.tenc,t)}},{key:"sinf",value:function(e){var t=new Uint8Array([]),r=new Uint8Array([e.data_format.charCodeAt(0),e.data_format.charCodeAt(1),e.data_format.charCodeAt(2),e.data_format.charCodeAt(3)]),i=new Uint8Array([0,0,0,0,99,101,110,99,0,1,0,0]),s=n.schi(e);return n.box(n.types.sinf,t,n.box(n.types.frma,r),n.box(n.types.schm,i),s)}},{key:"av01",value:function(e){return n.box(n.types.av01,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,e.width&255,e.height>>8&255,e.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),e.av1C,e.colr)}},{key:"avc1hev1",value:function(e){var t=e.codecType===$.HEVC,r=t?n.types.hvc1:n.types.avc1,i=t?n.hvcC(e):n.avcC(e),s=[new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,e.width&255,e.height>>8&255,e.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),i];return t?s.push(n.box(n.types.fiel,new Uint8Array([1,0]))):e.sarRatio&&e.sarRatio.length>1&&s.push(n.pasp(e.sarRatio)),n.box.apply(n,[r].concat(s))}},{key:"avcC",value:function(e){var t,r,i=[],s=[],o;return e.sps.forEach(function(u){o=u.byteLength,i.push(o>>>8&255),i.push(o&255),i.push.apply(i,N(u))}),e.pps.forEach(function(u){o=u.byteLength,s.push(o>>>8&255),s.push(o&255),s.push.apply(s,N(u))}),n.box(n.types.avcC,new Uint8Array((t=(r=[1,i[3],i[4],i[5],255,224|e.sps.length]).concat.apply(r,i).concat([e.pps.length])).concat.apply(t,s)))}},{key:"hvcC",value:function(e){var t=e.hvcC;if(t instanceof ArrayBuffer||t instanceof Uint8Array)return t;var r=e.vps,i=e.sps,s=e.pps,o;if(t){var u=t.generalProfileCompatibilityFlags,l=t.generalConstraintIndicatorFlags,f=(r.length&&1)+(i.length&&1)+(s.length&&1);o=[1,t.generalProfileSpace<<6|t.generalTierFlag<<5|t.generalProfileIdc,u>>>24,u>>>16,u>>>8,u,l[0],l[1],l[2],l[3],l[4],l[5],t.generalLevelIdc,240,0,252,t.chromaFormatIdc|252,t.bitDepthLumaMinus8|248,t.bitDepthChromaMinus8|248,0,0,t.numTemporalLayers<<3|t.temporalIdNested<<2|3,f];var c=function(d){var g;o.push(d.length>>8,d.length),(g=o).push.apply(g,N(d))};r.length&&(o.push(160,0,r.length),r.forEach(c)),i.length&&(o.push(161,0,i.length),i.forEach(c)),s.length&&(o.push(162,0,s.length),s.forEach(c))}else o=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return n.box(n.types.hvcC,new Uint8Array(o))}},{key:"pasp",value:function(e){var t=nt(e,2),r=t[0],i=t[1];return n.box(n.types.pasp,new Uint8Array([r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"mp4a",value:function(e){return n.box(n.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,e.sampleRate&255,0,0]),e.config.length?n.esds(e.config):void 0)}},{key:"esds",value:function(e){var t=e.length,r=n.box(n.types.esds,new Uint8Array([0,0,0,0,3,23+t,0,0,0,4,15+t,64,21,0,6,0,0,0,218,192,0,0,218,192,5].concat([t]).concat(e).concat([6,1,2])));return r}},{key:"opus",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.sampleRate>>8&255,e.sampleRate&255,0,0]),r=e.config.length?n.dOps(e):[];return n.box(n.types.Opus,t,r)}},{key:"dOps",value:function(e){if(e.config)return e.config[4]=e.sampleRate>>>24&255,e.config[5]=e.sampleRate>>>16&255,e.config[6]=e.sampleRate>>>8&255,e.config[7]=e.sampleRate&255,n.box(n.types.dOps,e.config)}},{key:"mvex",value:function(e){var t=n.box.apply(n,[n.types.mvex].concat(N(e.map(function(r){return n.trex(r.id)}))));return t}},{key:"trex",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]));return t}},{key:"trex1",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,2,0,0,0,0,0,0,1,0,0]));return t}},{key:"trex2",value:function(e){var t=n.box(n.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255,0,0,0,1,0,0,4,0,0,0,0,0,2,0,0,0]));return t}},{key:"moof",value:function(e){var t=n.box.apply(n,[n.types.moof,n.mfhd(e[0].samples?e[0].samples[0].gopId:0)].concat(N(e.map(function(r){return n.traf(r)}))));return t}},{key:"mfhd",value:function(e){var t=n.box(n.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]));return t}},{key:"traf",value:function(e){var t=n.tfhd(e.id),r=n.tfdt(e,e.baseMediaDecodeTime),i=0,s;if(e.isVideo&&e.videoSenc&&(s=e.videoSenc,s.forEach(function(q){i=i+8,q.subsamples&&q.subsamples.length&&(i=i+2,i=i+q.subsamples.length*6)})),e.videoSencLength=i,!e.useEME||!e.isVideoEncryption&&!e.isAudioEncryption){var o=n.sdtp(e),u=76;return n.box(n.types.traf,t,r,o,n.trun(e.samples,o.byteLength+u))}else if(e.isVideoEncryption)if(e.isVideo){var l=n.saiz(e),f=n.saio(e),c=n.trun1(e),v=n.senc(e),d=n.box(n.types.traf,t,r,l,f,c,v);return d}else if(e.isAudioEncryption){var p=n.sbgp(),m=n.saiz(e),U=n.saio(e),y=n.senc(e),S=n.trun1(e),w=n.box(n.types.traf,t,r,p,m,U,y,S);return w}else{var g=n.sbgp(),A=n.trun1(e);return n.box(n.types.traf,t,r,g,A)}else if(e.isVideo){var B=n.trun1(e);return n.box(n.types.traf,t,r,B)}else{var D=n.sbgp(),k=n.saiz(e),C=n.saio(e),I=n.senc(e),V=n.trun1(e),z=n.box(n.types.traf,t,r,D,k,C,I,V);return z}}},{key:"sdtp",value:function(e){var t=new F;return e.samples.forEach(function(r){t.write(new Uint8Array(e.isVideo?[r.keyframe?32:16]:[16]))}),n.box(n.types.sdtp,this.extension(0,0),t.buffer)}},{key:"trun1",value:function(e){var t=new F,r=F.writeUint32(e.samples.length),i=null;if(e.isVideo){var s=e.videoSencLength;i=F.writeUint32(e.samples.length*16+s+149),!e.isVideoEncryption&&e.isAudioEncryption&&(i=F.writeUint32(e.samples.length*16+92))}else{var o=e.samples.length*12+124;e.isAudioEncryption&&(o=e.samples.length*12+8*e.audioSenc.length+177),i=F.writeUint32(o)}return e.samples.forEach(function(u){t.write(F.writeUint32(u.duration)),t.write(F.writeUint32(u.size)),t.write(F.writeUint32(u.keyframe?33554432:65536)),e.isVideo&&t.write(F.writeUint32(u.cts?u.cts:0))}),n.box(n.types.trun,this.extension(0,e.flags),r,i,t.buffer)}},{key:"senc",value:function(e){var t=new F,r=e.samples.length,i=e.isVideo?16:8,s=e.isVideo?2:0,o=[],u=0;return e.isVideo?(o=e.videoSenc,u=e.videoSencLength):o=e.audioSenc,u=u||i*r,t.write(F.writeUint32(16+u),n.types.senc,this.extension(0,s)),t.write(F.writeUint32(r)),o.forEach(function(l){for(var f=0;f<l.InitializationVector.length;f++)t.write(new Uint8Array([l.InitializationVector[f]]));l.subsamples&&l.subsamples.length&&(t.write(F.writeUint16(l.subsamples.length)),l.subsamples.forEach(function(c){t.write(F.writeUint16(c.BytesOfClearData)),t.write(F.writeUint32(c.BytesOfProtectedData))}))}),t.buffer}},{key:"saio",value:function(e){var t=e.samples.length*12+141;!e.isVideo&&e.isAudioEncryption&&(t=149);var r=new Uint8Array([1,0,0,0,0,0,0,1,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saio,r)}},{key:"saiz",value:function(e){var t=e.samples.length,r=new Uint8Array([0,0,0,0,16,t>>24&255,t>>16&255,t>>8&255,t&255]);return n.box(n.types.saiz,r)}},{key:"sbgp",value:function(){var e=new Uint8Array([114,111,108,108,0,0,0,1,0,0,1,25,0,0,0,1]);return n.box(n.types.sbgp,this.extension(0,0),e)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,t&255])}},{key:"tfhd",value:function(e){return n.box(n.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}},{key:"tfdt",value:function(e,t){var r=Math.floor(t/(He+1)),i=Math.floor(t%(He+1));return e.useEME&&(e.isVideoEncryption||e.isAudioEncryption)?n.box(n.types.tfdt,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])):n.box(n.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255]))}},{key:"trun",value:function(e,t){var r=e.length,i=12+16*r;t+=8+i;var s=new Uint8Array(i);s.set([0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,r&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0);for(var o=0;o<r;o++){var u=e[o],l=u.duration,f=u.size,c=u.flag,v=c===void 0?{}:c,d=u.cts,g=d===void 0?0:d;s.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,f>>>24&255,f>>>16&255,f>>>8&255,f&255,v.isLeading<<2|(v.dependsOn===null||v.dependsOn===void 0?1:v.dependsOn),v.isDependedOn<<6|v.hasRedundancy<<4|v.paddingValue<<1|(v.isNonSyncSample===null||v.isNonSyncSample===void 0?1:v.isNonSyncSample),v.degradationPriority&61440,v.degradationPriority&15,g>>>24&255,g>>>16&255,g>>>8&255,g&255],12+16*o)}return n.box(n.types.trun,s)}},{key:"moovMP4",value:function(e){return n.box.apply(n,[n.types.moov,n.mvhd(e[0].duration,e[0].timescale)].concat(N(e.map(function(t){return n.trackMP4(t)}))))}},{key:"trackMP4",value:function(e){return n.box(n.types.trak,n.tkhd(e.id,e.duration,e.width,e.height),n.mdiaMP4(e))}},{key:"mdiaMP4",value:function(e){return n.box(n.types.mdia,n.mdhd(e.duration,e.timescale),n.hdlr(e.type),n.minfMP4(e))}},{key:"minfMP4",value:function(e){return n.box(n.types.minf,e.type===ie.VIDEO?n.VMHD:n.SMHD,n.DINF,n.stblMP4(e))}},{key:"stblMP4",value:function(e){var t=e.ext,r=[n.stsd(e),n.stts(t.stts),n.stsc(t.stsc),n.stsz(t.stsz),n.stco(t.stco)];return t.stss.length&&r.push(n.stss(t.stss)),t.ctts.length&&r.push(n.ctts(t.ctts)),n.box.apply(n,[n.types.stbl].concat(r))}},{key:"stts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(s){var o=s.value,u=s.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.stts,H(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsc",value:function(e){var t=e.length,r=new Uint8Array(12*t),i=0;return e.forEach(function(s){var o=s.firstChunk,u=s.samplesPerChunk,l=s.sampleDescIndex;r.set([o>>24,o>>16&255,o>>8&255,o&255,u>>24,u>>16&255,u>>8&255,u&255,l>>24,l>>16&255,l>>8&255,l&255],i),i+=12}),n.box(n.types.stsc,H(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stsz",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stsz,H(new Uint8Array([0,0,0,0,0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stco",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stco,H(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"stss",value:function(e){var t=e.length,r=new Uint8Array(4*t),i=0;return e.forEach(function(s){r.set([s>>24,s>>16&255,s>>8&255,s&255],i),i+=4}),n.box(n.types.stss,H(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"ctts",value:function(e){var t=e.length,r=new Uint8Array(8*t),i=0;return e.forEach(function(s){var o=s.value,u=s.count;r.set([u>>24,u>>16&255,u>>8&255,u&255,o>>24,o>>16&255,o>>8&255,o&255],i),i+=8}),n.box(n.types.ctts,H(new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]),r))}},{key:"styp",value:function(){return n.box(n.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120]))}},{key:"sidx",value:function(e){var t=e.timescale,r=e.samples[0].duration,i=r*e.samples.length,s=e.samples[0].sampleOffset*r,o=8;e.samples.forEach(function(v){o+=v.size});var u=0;if(e.isVideo){var l=0,f;e.videoSenc&&(f=e.videoSenc),e.isVideo&&f.forEach(function(v){l=l+8,v.subsamples&&v.subsamples.length&&(l=l+2,l=l+v.subsamples.length*6)}),e.videoSencLength=l,u=o+141+e.samples.length*16+l,e.useEME&&e.isAudioEncryption&&!e.isVideoEncryption&&(u=o+e.samples.length*16+84)}else u=o+116+e.samples.length*12,e.useEME&&e.isAudioEncryption&&(u=o+169+e.samples.length*12+8*e.audioSenc.length);var c=new Uint8Array([0,0,0,0,0,0,0,e.id&255,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24&255,s>>16&255,s>>8&255,s&255,0,0,0,0,0,0,0,1,0,u>>16&255,u>>8&255,u&255,i>>24&255,i>>16&255,i>>8&255,i&255,144,0,0,0]);return n.box(n.types.sidx,c)}},{key:"mdat",value:function(e){var t=n.box(n.types.mdat,e);return t}}]),n}();h(_,"types",["Opus","dOps","av01","av1C","avc1","avcC","hvc1","hvcC","dinf","dref","esds","ftyp","hdlr","mdat","mdhd","mdia","mfhd","minf","moof","moov","mp4a","mvex","mvhd","pasp","stbl","stco","stsc","stsd","stsz","stts","tfdt","tfhd","traf","trak","trex","tkhd","vmhd","smhd","ctts","stss","styp","pssh","sidx","sbgp","saiz","saio","senc","trun","encv","enca","sinf","btrt","frma","tenc","schm","schi","mehd","fiel","sdtp"].reduce(function(n,a){return n[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)],n},Object.create(null)));h(_,"HDLR_TYPES",{video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])});h(_,"FTYPAVC1",_.box(_.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49])));h(_,"FTYPHEV1",_.box(_.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,104,101,118,49])));h(_,"DINF",_.box(_.types.dinf,_.box(_.types.dref,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]))));h(_,"VMHD",_.box(_.types.vmhd,new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])));h(_,"SMHD",_.box(_.types.smhd,new Uint8Array([0,0,0,0,0,0,0,0])));h(_,"StblTable",new Uint8Array([0,0,0,0,0,0,0,0]));h(_,"STTS",_.box(_.types.stts,_.StblTable));h(_,"STSC",_.box(_.types.stsc,_.StblTable));h(_,"STSZ",_.box(_.types.stsz,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0])));h(_,"STCO",_.box(_.types.stco,_.StblTable));var Ye=function(){function n(a,e){M(this,n),this.name=a||"",this._prefix="[".concat(this.name,"]"),n.disabled=e}return R(n,[{key:"debug",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).debug.apply(e,[this._prefix].concat(r))}}},{key:"log",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).log.apply(e,[this._prefix].concat(r))}}},{key:"warn",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).warn.apply(e,[this._prefix].concat(r))}}},{key:"error",value:function(){var e;if(!n.disabled){for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];(e=console).error.apply(e,[this._prefix].concat(r))}}},{key:"table",value:function(){var e;n.disabled||(e=console).table.apply(e,arguments)}}],[{key:"enable",value:function(){n.disabled=!1}},{key:"disable",value:function(){n.disabled=!0}}]),n}();h(Ye,"disabled",!0);var Bt=function(){function n(a,e,t){M(this,n),this.videoTrack=a,this.audioTrack=e;var r=/Chrome\/([^.]+)/.exec(navigator.userAgent);this.forceFirstIDR=r&&Number(r[1])<50,this.log=new Ye("FMP4Remuxer",t&&t.openLog?!t.openLog:!0)}return R(n,[{key:"remux",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.videoTrack,i=this.audioTrack,s=r.exist(),o=i.exist(),u,l,f,c=[];e&&(t&&t.initMerge?(s&&c.push(this.videoTrack),o&&c.push(this.audioTrack),f=_.initSegment(c)):(s&&(u=_.initSegment([this.videoTrack])),o&&(l=_.initSegment([this.audioTrack]))));var v,d;return s&&r.hasSample()&&(v=this._remuxVideo()),o&&i.hasSample()&&(d=this._remuxAudio()),r.samples=[],i.samples=[],{initSegment:f,videoInitSegment:u,audioInitSegment:l,videoSegment:v,audioSegment:d}}},{key:"_remuxVideo",value:function(){var e=this.videoTrack;this.forceFirstIDR&&(e.samples[0].flag={dependsOn:2,isNonSyncSample:0});var t=e.samples,r=/av01/.test(e.codec),i=0;r?t.forEach(function(y){i+=y.data.byteLength}):t.forEach(function(y){i+=y.units.reduce(function(S,w){return S+w.byteLength},0),i+=y.units.length*4});var s=new Uint8Array(i);if(r)for(var o=0,u=t.length,l=0,f;o<u;o++)f=t[o],s.set(f.data,l),f.size=f.data.byteLength,l+=f.size;else for(var c=new DataView(s.buffer),v=function(S,w){w=t[d];var B=0;w.units.forEach(function(D){c.setUint32(S,D.byteLength),S+=4,s.set(D,S),S+=D.byteLength,B+=4+D.byteLength}),w.size=B,A=S,p=w},d=0,g=t.length,A=0,p;d<g;d++)v(A,p);var m=_.mdat(s),U=_.moof([e]);return H(U,m)}},{key:"_remuxAudio",value:function(){var e=this.audioTrack,t=new Uint8Array(e.samples.reduce(function(s,o){return s+o.size},0));e.samples.reduce(function(s,o){return t.set(o.data,s),s+o.size},0);var r=_.mdat(t),i=_.moof([e]);return H(i,r)}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset()}}]),n}();export{Ut as F,Xe as L,O as M,ie as T,ne as W,kt as a,Bt as b};
