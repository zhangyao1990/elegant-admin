
/**
 * 由 MrZhang 提供技术支持
 * Powered by elegant-admin
 * Github https://github.com/zhangyao1990/elegant-admin
 */

import{E as Ge}from"./eventemitter3-Br74xS_E.js";import{c as fe,E as P,L as ae,S as x,a as Q,M as W,B as z,N as ne,b as He,i as Ye,d as je,G as xe,e as Ke,g as Xe}from"./xgplayer-streaming-shared-bIIOT1o7.js";import{T as ke,W as te,F as We,a as Ce,b as Qe,M as re,L as we}from"./xgplayer-transmuxer-CLGXheUD.js";import{B as Te,U as ze,S as qe,D as Je,E as Ze,a as et}from"./xgplayer-CJwnBCxZ.js";function tt(o,s){var t=o==null?null:typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(t!=null){var r,e,i,a,n=[],l=!0,u=!1;try{if(i=(t=t.call(o)).next,s===0){if(Object(t)!==t)return;l=!1}else for(;!(l=(r=i.call(t)).done)&&(n.push(r.value),n.length!==s);l=!0);}catch(h){u=!0,e=h}finally{try{if(!l&&t.return!=null&&(a=t.return(),Object(a)!==a))return}finally{if(u)throw e}}return n}}function Le(o,s){var t=Object.keys(o);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(o);s&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})),t.push.apply(t,r)}return t}function M(o){for(var s=1;s<arguments.length;s++){var t=arguments[s]!=null?arguments[s]:{};s%2?Le(Object(t),!0).forEach(function(r){c(o,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)):Le(Object(t)).forEach(function(r){Object.defineProperty(o,r,Object.getOwnPropertyDescriptor(t,r))})}return o}function E(){E=function(){return o};var o={},s=Object.prototype,t=s.hasOwnProperty,r=Object.defineProperty||function(v,g,_){v[g]=_.value},e=typeof Symbol=="function"?Symbol:{},i=e.iterator||"@@iterator",a=e.asyncIterator||"@@asyncIterator",n=e.toStringTag||"@@toStringTag";function l(v,g,_){return Object.defineProperty(v,g,{value:_,enumerable:!0,configurable:!0,writable:!0}),v[g]}try{l({},"")}catch{l=function(g,_,A){return g[_]=A}}function u(v,g,_,A){var k=g&&g.prototype instanceof p?g:p,O=Object.create(k.prototype),B=new C(A||[]);return r(O,"_invoke",{value:L(v,_,B)}),O}function h(v,g,_){try{return{type:"normal",arg:v.call(g,_)}}catch(A){return{type:"throw",arg:A}}}o.wrap=u;var m={};function p(){}function d(){}function f(){}var y={};l(y,i,function(){return this});var S=Object.getPrototypeOf,b=S&&S(S(j([])));b&&b!==s&&t.call(b,i)&&(y=b);var T=f.prototype=p.prototype=Object.create(y);function N(v){["next","throw","return"].forEach(function(g){l(v,g,function(_){return this._invoke(g,_)})})}function w(v,g){function _(k,O,B,H){var X=h(v[k],v,O);if(X.type!=="throw"){var ee=X.arg,ue=ee.value;return ue&&typeof ue=="object"&&t.call(ue,"__await")?g.resolve(ue.__await).then(function(Z){_("next",Z,B,H)},function(Z){_("throw",Z,B,H)}):g.resolve(ue).then(function(Z){ee.value=Z,B(ee)},function(Z){return _("throw",Z,B,H)})}H(X.arg)}var A;r(this,"_invoke",{value:function(k,O){function B(){return new g(function(H,X){_(k,O,H,X)})}return A=A?A.then(B,B):B()}})}function L(v,g,_){var A="suspendedStart";return function(k,O){if(A==="executing")throw new Error("Generator is already running");if(A==="completed"){if(k==="throw")throw O;return $()}for(_.method=k,_.arg=O;;){var B=_.delegate;if(B){var H=U(B,_);if(H){if(H===m)continue;return H}}if(_.method==="next")_.sent=_._sent=_.arg;else if(_.method==="throw"){if(A==="suspendedStart")throw A="completed",_.arg;_.dispatchException(_.arg)}else _.method==="return"&&_.abrupt("return",_.arg);A="executing";var X=h(v,g,_);if(X.type==="normal"){if(A=_.done?"completed":"suspendedYield",X.arg===m)continue;return{value:X.arg,done:_.done}}X.type==="throw"&&(A="completed",_.method="throw",_.arg=X.arg)}}}function U(v,g){var _=g.method,A=v.iterator[_];if(A===void 0)return g.delegate=null,_==="throw"&&v.iterator.return&&(g.method="return",g.arg=void 0,U(v,g),g.method==="throw")||_!=="return"&&(g.method="throw",g.arg=new TypeError("The iterator does not provide a '"+_+"' method")),m;var k=h(A,v.iterator,g.arg);if(k.type==="throw")return g.method="throw",g.arg=k.arg,g.delegate=null,m;var O=k.arg;return O?O.done?(g[v.resultName]=O.value,g.next=v.nextLoc,g.method!=="return"&&(g.method="next",g.arg=void 0),g.delegate=null,m):O:(g.method="throw",g.arg=new TypeError("iterator result is not an object"),g.delegate=null,m)}function Y(v){var g={tryLoc:v[0]};1 in v&&(g.catchLoc=v[1]),2 in v&&(g.finallyLoc=v[2],g.afterLoc=v[3]),this.tryEntries.push(g)}function F(v){var g=v.completion||{};g.type="normal",delete g.arg,v.completion=g}function C(v){this.tryEntries=[{tryLoc:"root"}],v.forEach(Y,this),this.reset(!0)}function j(v){if(v){var g=v[i];if(g)return g.call(v);if(typeof v.next=="function")return v;if(!isNaN(v.length)){var _=-1,A=function k(){for(;++_<v.length;)if(t.call(v,_))return k.value=v[_],k.done=!1,k;return k.value=void 0,k.done=!0,k};return A.next=A}}return{next:$}}function $(){return{value:void 0,done:!0}}return d.prototype=f,r(T,"constructor",{value:f,configurable:!0}),r(f,"constructor",{value:d,configurable:!0}),d.displayName=l(f,n,"GeneratorFunction"),o.isGeneratorFunction=function(v){var g=typeof v=="function"&&v.constructor;return!!g&&(g===d||(g.displayName||g.name)==="GeneratorFunction")},o.mark=function(v){return Object.setPrototypeOf?Object.setPrototypeOf(v,f):(v.__proto__=f,l(v,n,"GeneratorFunction")),v.prototype=Object.create(T),v},o.awrap=function(v){return{__await:v}},N(w.prototype),l(w.prototype,a,function(){return this}),o.AsyncIterator=w,o.async=function(v,g,_,A,k){k===void 0&&(k=Promise);var O=new w(u(v,g,_,A),k);return o.isGeneratorFunction(g)?O:O.next().then(function(B){return B.done?B.value:O.next()})},N(T),l(T,n,"Generator"),l(T,i,function(){return this}),l(T,"toString",function(){return"[object Generator]"}),o.keys=function(v){var g=Object(v),_=[];for(var A in g)_.push(A);return _.reverse(),function k(){for(;_.length;){var O=_.pop();if(O in g)return k.value=O,k.done=!1,k}return k.done=!0,k}},o.values=j,C.prototype={constructor:C,reset:function(v){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(F),!v)for(var g in this)g.charAt(0)==="t"&&t.call(this,g)&&!isNaN(+g.slice(1))&&(this[g]=void 0)},stop:function(){this.done=!0;var v=this.tryEntries[0].completion;if(v.type==="throw")throw v.arg;return this.rval},dispatchException:function(v){if(this.done)throw v;var g=this;function _(X,ee){return O.type="throw",O.arg=v,g.next=X,ee&&(g.method="next",g.arg=void 0),!!ee}for(var A=this.tryEntries.length-1;A>=0;--A){var k=this.tryEntries[A],O=k.completion;if(k.tryLoc==="root")return _("end");if(k.tryLoc<=this.prev){var B=t.call(k,"catchLoc"),H=t.call(k,"finallyLoc");if(B&&H){if(this.prev<k.catchLoc)return _(k.catchLoc,!0);if(this.prev<k.finallyLoc)return _(k.finallyLoc)}else if(B){if(this.prev<k.catchLoc)return _(k.catchLoc,!0)}else{if(!H)throw new Error("try statement without catch or finally");if(this.prev<k.finallyLoc)return _(k.finallyLoc)}}}},abrupt:function(v,g){for(var _=this.tryEntries.length-1;_>=0;--_){var A=this.tryEntries[_];if(A.tryLoc<=this.prev&&t.call(A,"finallyLoc")&&this.prev<A.finallyLoc){var k=A;break}}k&&(v==="break"||v==="continue")&&k.tryLoc<=g&&g<=k.finallyLoc&&(k=null);var O=k?k.completion:{};return O.type=v,O.arg=g,k?(this.method="next",this.next=k.finallyLoc,m):this.complete(O)},complete:function(v,g){if(v.type==="throw")throw v.arg;return v.type==="break"||v.type==="continue"?this.next=v.arg:v.type==="return"?(this.rval=this.arg=v.arg,this.method="return",this.next="end"):v.type==="normal"&&g&&(this.next=g),m},finish:function(v){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.finallyLoc===v)return this.complete(_.completion,_.afterLoc),F(_),m}},catch:function(v){for(var g=this.tryEntries.length-1;g>=0;--g){var _=this.tryEntries[g];if(_.tryLoc===v){var A=_.completion;if(A.type==="throw"){var k=A.arg;F(_)}return k}}throw new Error("illegal catch attempt")},delegateYield:function(v,g,_){return this.delegate={iterator:j(v),resultName:g,nextLoc:_},this.method==="next"&&(this.arg=void 0),m}},o}function oe(o){"@babel/helpers - typeof";return oe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},oe(o)}function Ae(o,s,t,r,e,i,a){try{var n=o[i](a),l=n.value}catch(u){t(u);return}n.done?s(l):Promise.resolve(l).then(r,e)}function R(o){return function(){var s=this,t=arguments;return new Promise(function(r,e){var i=o.apply(s,t);function a(l){Ae(i,r,e,a,n,"next",l)}function n(l){Ae(i,r,e,a,n,"throw",l)}a(void 0)})}}function V(o,s){if(!(o instanceof s))throw new TypeError("Cannot call a class as a function")}function De(o,s){for(var t=0;t<s.length;t++){var r=s[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(o,Ne(r.key),r)}}function G(o,s,t){return s&&De(o.prototype,s),t&&De(o,t),Object.defineProperty(o,"prototype",{writable:!1}),o}function c(o,s,t){return s=Ne(s),s in o?Object.defineProperty(o,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[s]=t,o}function me(o,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");o.prototype=Object.create(s&&s.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),Object.defineProperty(o,"prototype",{writable:!1}),s&&ye(o,s)}function de(o){return de=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},de(o)}function ye(o,s){return ye=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,e){return r.__proto__=e,r},ye(o,s)}function rt(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function it(o,s){if(o==null)return{};var t={},r=Object.keys(o),e,i;for(i=0;i<r.length;i++)e=r[i],!(s.indexOf(e)>=0)&&(t[e]=o[e]);return t}function _e(o,s){if(o==null)return{};var t=it(o,s),r,e;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(o);for(e=0;e<i.length;e++)r=i[e],!(s.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(o,r)&&(t[r]=o[r])}return t}function D(o){if(o===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return o}function nt(o,s){if(s&&(typeof s=="object"||typeof s=="function"))return s;if(s!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return D(o)}function ve(o){var s=rt();return function(){var r=de(o),e;if(s){var i=de(this).constructor;e=Reflect.construct(r,arguments,i)}else e=r.apply(this,arguments);return nt(this,e)}}function J(o,s){return ut(o)||tt(o,s)||Me(o,s)||ht()}function at(o){return st(o)||ot(o)||Me(o)||lt()}function st(o){if(Array.isArray(o))return be(o)}function ut(o){if(Array.isArray(o))return o}function ot(o){if(typeof Symbol<"u"&&o[Symbol.iterator]!=null||o["@@iterator"]!=null)return Array.from(o)}function Me(o,s){if(o){if(typeof o=="string")return be(o,s);var t=Object.prototype.toString.call(o).slice(8,-1);if(t==="Object"&&o.constructor&&(t=o.constructor.name),t==="Map"||t==="Set")return Array.from(o);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return be(o,s)}}function be(o,s){(s==null||s>o.length)&&(s=o.length);for(var t=0,r=new Array(s);t<s;t++)r[t]=o[t];return r}function lt(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ht(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function ct(o,s){if(typeof o!="object"||o===null)return o;var t=o[Symbol.toPrimitive];if(t!==void 0){var r=t.call(o,s||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(o)}function Ne(o){var s=ct(o,"string");return typeof s=="symbol"?s:String(s)}var ft=function(){function o(){V(this,o);var s=window.crypto||window.msCrypto;this.subtle=s&&(s.subtle||s.webkitSubtle),this.externalDecryptor=null}return G(o,[{key:"destroy",value:function(){var t;(t=this.externalDecryptor)!==null&&t!==void 0&&t.destroy&&this.externalDecryptor.destroy()}},{key:"decrypt",value:function(t,r){if(!(!t&&!r)){var e=[];return t&&(e[0]=this._decryptSegment(t)),r&&(e[1]=this._decryptSegment(r)),Promise.all(e)}}},{key:"_decryptSegment",value:function(){var s=R(E().mark(function r(e){var i;return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(i=e.data,!e.key){n.next=5;break}return n.next=4,this._decryptData(e.data,e.key,e.keyIv);case 4:i=n.sent;case 5:if(e.map){n.next=7;break}return n.abrupt("return",i);case 7:return n.abrupt("return",fe(e.map,i));case 8:case"end":return n.stop()}},r,this)}));function t(r){return s.apply(this,arguments)}return t}()},{key:"_decryptData",value:function(){var s=R(E().mark(function r(e,i,a){var n;return E().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(!this.externalDecryptor){u.next=6;break}return u.next=3,this.externalDecryptor.decrypt(e,i,a);case 3:return u.abrupt("return",u.sent);case 6:if(this.subtle){u.next=8;break}throw new Error("crypto is not defined");case 8:return u.next=10,this.subtle.importKey("raw",i,{name:"AES-CBC"},!1,["encrypt","decrypt"]);case 10:return n=u.sent,u.t0=Uint8Array,u.next=14,this.subtle.decrypt({name:"AES-CBC",iv:a},n,e);case 14:return u.t1=u.sent,u.abrupt("return",new u.t0(u.t1));case 16:case"end":return u.stop()}},r,this)}));function t(r,e,i){return s.apply(this,arguments)}return t}()}]),o}(),I=M(M({},P),{},{STREAM_PARSED:"core.streamparsed",NO_AUDIO_TRACK:"core.noaudiotrack",SUBTITLE_SEGMENTS:"core.subtitlesegments",SUBTITLE_PLAYLIST:"core.subtitleplaylist",SEI_PAYLOAD_TIME:"core.seipayloadtime",APPEND_COST:"core.appendcost"}),pe=new ae("Transmuxer"),Pe=function(){function o(s,t,r,e){V(this,o),c(this,"_initSegmentId",""),this.hls=s,this._demuxer=t?new We:new Ce(null,null,null,e),this._isMP4=t,r&&(this._remuxer=new Qe(this._demuxer.videoTrack,this._demuxer.audioTrack))}return G(o,[{key:"transmux",value:function(t,r,e,i,a,n){var l=this._demuxer;try{this._isMP4?l.demux(t,r):l.demuxAndFix(fe(t,r),e,i,a)}catch(U){throw new x(Q.DEMUX,Q.SUB_TYPES.HLS,U)}var u=l.videoTrack,h=l.audioTrack,m=l.metadataTrack,p={codec:u.codec,timescale:u.timescale,firstDts:u.firstDts/u.timescale,firstPts:u.firstPts/u.timescale,duration:u.samplesDuration/u.timescale},d={codec:h.codec,timescale:h.timescale,firstDts:h.firstDts/u.timescale,firstPts:h.firstPts/u.timescale,duration:h.samplesDuration/u.timescale},f="".concat(u.codec,"/").concat(u.width,"/").concat(u.height,"/").concat(h.codec,"/").concat(h.config);if(f!==this._initSegmentId&&(this._initSegmentId=f,n=!0),this._fireEvents(u,h,m,e||n),this.hls.emit(I.DEMUXED_TRACK,{videoTrack:u,audioTrack:h}),this._remuxer){n&&this.hls.isLive&&!this.hls.config.mseLowLatency&&(u.duration=this.hls.totalDuration*u.timescale,h.duration=this.hls.totalDuration*h.timescale);try{var y=this._remuxer.remux(n),S=y.videoInitSegment,b=y.videoSegment,T=y.audioInitSegment,N=y.audioSegment,w=fe(S,b),L=fe(T,N);return[w?M(M({},p),{},{data:w}):void 0,L?M(M({},d),{},{data:L}):void 0]}catch(U){throw new x(Q.REMUX,Q.SUB_TYPES.FMP4,U)}}else return[u,h]}},{key:"_fireEvents",value:function(t,r,e,i){var a=this,n=[t,r],l="discontinuity: ".concat(i);n.forEach(function(u){var h;(h=u.samples)!==null&&h!==void 0&&h.length&&(l+="; ".concat(u.samples.length," ").concat(u.type===ke.VIDEO?"video":"audio"," samples, firstDts/firstPts/duration: ").concat((u.firstDts/u.timescale).toFixed(3),"/").concat((u.firstPts/u.timescale).toFixed(3),"/").concat((u.samplesDuration/u.timescale).toFixed(3))),i&&u.exist()&&a.hls.emit(I.METADATA_PARSED,{type:u.type,track:u,meta:M({codec:u.codec,timescale:u.timescale,baseDts:u.baseDts},u.type===ke.VIDEO?{width:u.width,height:u.height,sarRatio:u.sarRatio}:{codec:u.codec,channelCount:u.channelCount,sampleRate:u.sampleRate})})}),pe.debug(l),t.warnings.forEach(function(u){var h;switch(u.type){case te.LARGE_AV_SHIFT:h=I.LARGE_AV_FIRST_FRAME_GAP_DETECT;break;case te.LARGE_VIDEO_GAP:h=I.LARGE_VIDEO_DTS_GAP_DETECT;break;case te.LARGE_VIDEO_GAP_BETWEEN_CHUNK:h=I.MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT;break}h&&a.hls.emit(I.STREAM_EXCEPTION,M(M({},u),{},{type:h})),pe.warn("video exception",u)}),r.warnings.forEach(function(u){var h;switch(u.type){case te.LARGE_AUDIO_GAP:h=I.LARGE_AUDIO_DTS_GAP_DETECT;break;case te.AUDIO_FILLED:h=I.AUDIO_GAP_DETECT;break;case te.AUDIO_DROPPED:h=I.AUDIO_OVERLAP_DETECT;break}h&&a.hls.emit(I.STREAM_EXCEPTION,M(M({},u),{},{type:h})),pe.warn("audio exception",u)}),t.samples.forEach(function(u){u.keyframe&&a.hls.emit(I.KEYFRAME,{pts:u.pts})}),e.seiSamples.forEach(function(u){a.hls.emit(I.SEI,M(M({},u),{},{originPts:u.originPts/90,sei:{code:u.data.type,content:u.data.payload,dts:u.pts}}))})}}]),o}(),dt=["data"],mt=["data"],Ie=new ae("BufferService"),vt=function(){function o(s){var t=this;V(this,o),c(this,"_decryptor",new ft),c(this,"_transmuxer",null),c(this,"_mse",null),c(this,"_softVideo",null),c(this,"_sourceCreated",!1),c(this,"_needInitSegment",!0),c(this,"_directAppend",!1),this.hls=s,s.config.softDecode?this._softVideo=s.media:(this._mse=new W(null,{preferMMS:s.config.preferMMS}),s.config.url&&this._mse.bindMedia(s.media).then(function(r){t.hls.emit(P.MEDIASOURCE_OPENED,r)})),s.config.decryptor&&(this._decryptor.externalDecryptor=s.config.decryptor)}return G(o,[{key:"baseDts",get:function(){var t,r,e;return(t=this._transmuxer)===null||t===void 0||(r=t._demuxer)===null||r===void 0||(e=r._fixer)===null||e===void 0?void 0:e._baseDts}},{key:"nbSb",get:function(){var t;return(t=this._mse)!==null&&t!==void 0&&t._sourceBuffer?Object.keys(this._mse._sourceBuffer).length:0}},{key:"msIsOpened",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.isOpened}},{key:"msHasOpTasks",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.hasOpTasks}},{key:"msStreaming",get:function(){var t;return(t=this._mse)===null||t===void 0?void 0:t.streaming}},{key:"updateDuration",value:function(){var s=R(E().mark(function r(e){return E().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(Ie.debug("update duration",e),!this._mse){a.next=9;break}if(this._mse.isOpened){a.next=5;break}return a.next=5,this._mse.open();case 5:return a.next=7,this._mse.updateDuration(e);case 7:a.next=10;break;case 9:this._softVideo&&(this._softVideo.duration=e);case 10:case"end":return a.stop()}},r,this)}));function t(r){return s.apply(this,arguments)}return t}()},{key:"createSource",value:function(t,r,e,i){if(!this._sourceCreated){var a=t||r;if(a){if(Ce.probe(a))this._transmuxer||(this._transmuxer=new Pe(this.hls,!1,!this._softVideo,this.hls.config.fixerConfig));else if(re.probe(a))if(this._softVideo)this._transmuxer||(this._transmuxer=new Pe(this.hls,!0,null,this.hls.config.fixerConfig));else{this._directAppend=!0;var n=!1;t&&!e&&re.findBox(t,["moov","trak"]).forEach(function(l){var u=re.findBox(l.data,["trak","mdia","minf","stbl","stsd"])[0];if(u){var h=re.stsd(u).entries[0];if(h){if(h.hvcC)e=h.hvcC.codec||"hev1.1.6.L93.B0";else if(h.avcC)e=h.avcC.codec;else if(h.sampleRate||h.esds){var m;i=((m=h.esds)===null||m===void 0?void 0:m.codec)||"mp4a.40.2",n=!0}}}}),r&&!i&&re.findBox(r,["moov","trak","mdia","minf","stbl","stsd"]).forEach(function(l){var u=re.stsd(l).entries[0];u&&u.esds&&(i=u.esds.codec)}),t&&!e&&(e="avc1.42e01e"),r&&!i&&(i="mp4a.40.2"),n&&(e+=", ".concat(i),i=""),this._createMseSource(e,i)}else throw new x(Q.OTHER,null,null,null,"unsupported stream");this._softVideo&&(this._sourceCreated=!0)}}}},{key:"appendBuffer",value:function(){var s=R(E().mark(function r(e,i,a,n,l,u,h){var m=this,p,d,f,y,S,b,T,N,w,L,U,Y,F,C;return E().wrap(function($){for(;;)switch($.prev=$.next){case 0:if(!(!(a!=null&&a.length)&&!(n!=null&&n.length))){$.next=2;break}return $.abrupt("return");case 2:if(p=function(){var g;if((g=m.hls)!==null&&g!==void 0&&g.emit){var _;(_=m.hls)===null||_===void 0||_.emit(P.APPEND_BUFFER,{start:e.start,end:e.end})}},!this._directAppend){$.next=8;break}return d=[],a&&d.push(this._mse.append(W.VIDEO,a)),n&&d.push(this._mse.append(W.AUDIO,n)),$.abrupt("return",Promise.all(d).then(p));case 8:if(f=this._needInitSegment||l,y=this._transmuxer.transmux(a,n,f,u,h,this._needInitSegment||l),S=J(y,2),b=S[0],T=S[1],n&&i&&(i==null||i.setTrackExist(!1,!0)),n&&e&&(e==null||e.setTrackExist(!0,!1)),i||e==null||e.setTrackExist(!!b,!!T),b&&!T&&this.hls.emit(I.NO_AUDIO_TRACK),!this._softVideo){$.next=20;break}this._softVideo.appendBuffer(b,T),this._needInitSegment=!1,p(),$.next=30;break;case 20:if(!this._mse){$.next=30;break}return N=!this._sourceCreated,N&&this._createMseSource(b==null?void 0:b.codec,T==null?void 0:T.codec),this._needInitSegment=!1,w=this._mse,L=[],f&&!N&&this._handleCodecChange(b,T).forEach(function(v){return L.push(v)}),b&&(U=b.data,Y=_e(b,dt),L.push(w.append(W.VIDEO,U,Y))),T&&(F=T.data,C=_e(T,mt),L.push(w.append(W.AUDIO,F,C))),$.abrupt("return",Promise.all(L).then(p));case 30:case"end":return $.stop()}},r,this)}));function t(r,e,i,a,n,l,u){return s.apply(this,arguments)}return t}()},{key:"removeBuffer",value:function(){var s=R(E().mark(function r(){var e=this,i,a,n,l=arguments;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=l.length>0&&l[0]!==void 0?l[0]:0,a=l.length>1&&l[1]!==void 0?l[1]:1/0,n=this.hls.media,!(!this._mse||!n||i<0||a<i||i>=this._mse.duration)){h.next=5;break}return h.abrupt("return");case 5:return h.abrupt("return",this._mse.clearBuffer(i,a).then(function(){return e.hls.emit(P.REMOVE_BUFFER,{start:i,end:a,removeEnd:a})}));case 6:case"end":return h.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"evictBuffer",value:function(){var s=R(E().mark(function r(e){var i,a,n,l;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=this.hls.media,!(!this._mse||!i||!e||e<0)){h.next=3;break}return h.abrupt("return");case 3:if(a=i.currentTime,n=a-e,!(n<=0)){h.next=7;break}return h.abrupt("return");case 7:if(l=z.start(z.get(i)),!(l+1>=n)){h.next=10;break}return h.abrupt("return");case 10:return h.abrupt("return",this.removeBuffer(0,n));case 11:case"end":return h.stop()}},r,this)}));function t(r){return s.apply(this,arguments)}return t}()},{key:"clearAllBuffer",value:function(){var s=R(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=2;break}return i.abrupt("return",this._mse.clearAllBuffer());case 2:case"end":return i.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"decryptBuffer",value:function(t,r){return this._decryptor.decrypt(t,r)}},{key:"reset",value:function(){var s=R(E().mark(function r(){var e,i=arguments;return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e=i.length>0&&i[0]!==void 0?i[0]:!1,!(this._mse&&!e)){n.next=8;break}return this._transmuxer=null,this._sourceCreated=!1,n.next=6,this._mse.unbindMedia();case 6:return n.next=8,this._mse.bindMedia(this.hls.media);case 8:this._needInitSegment=!0,this._directAppend=!1;case 10:case"end":return n.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"endOfStream",value:function(){var s=R(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=5;break}if(!this._sourceCreated){i.next=5;break}return i.next=4,this._mse.endOfStream();case 4:this.hls.emit(P.BUFFEREOS);case 5:this._softVideo&&this._softVideo.endOfStream();case 6:case"end":return i.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"setLiveSeekableRange",value:function(){var s=R(E().mark(function r(e,i){return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:this._mse&&this._mse.setLiveSeekableRange(e,i);case 1:case"end":return n.stop()}},r,this)}));function t(r,e){return s.apply(this,arguments)}return t}()},{key:"detachMedia",value:function(){var s=R(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=3;break}return i.next=3,this._mse.unbindMedia();case 3:case"end":return i.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"destroy",value:function(){var s=R(E().mark(function r(){var e;return E().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return(e=this._decryptor)===null||e===void 0||e.destroy(),a.next=3,this.detachMedia();case 3:this._decryptor=null,this._mse=null,this._softVideo=null;case 6:case"end":return a.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()},{key:"_createMseSource",value:function(t,r){Ie.debug("create mse source, videoCodec=".concat(t,", audioCodec=").concat(r));var e=this._mse;e&&(t&&(e.createSource(W.VIDEO,"video/mp4;codecs=".concat(t)),this._sourceCreated=!0),r&&(e.createSource(W.AUDIO,"audio/mp4;codecs=".concat(r)),this._sourceCreated=!0),this.hls.emit(P.SOURCEBUFFER_CREATED))}},{key:"_handleCodecChange",value:function(t,r){var e=[],i=this._mse,a=[{type:W.VIDEO,codecs:t==null?void 0:t.codec},{type:W.AUDIO,codecs:r==null?void 0:r.codec}];return a.filter(function(n){return!!n.codecs}).forEach(function(n){var l=n.type,u=n.codecs,h=i.getSourceBuffer(l);if(h){var m=u.split(",")[0];new RegExp(m,"ig").test(h.mimeType)||e.push(i.changeType(l,"".concat(l,"/mp4;codecs=").concat(u)))}}),e}},{key:"seamlessSwitch",value:function(){this._needInitSegment=!0}},{key:"isFull",value:function(){var t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:W.VIDEO;return(t=this._mse)===null||t===void 0?void 0:t.isFull(r)}}]),o}();function pt(o){var s=(o==null?void 0:o.media)||document.createElement("video");return M(M({maxPlaylistSize:50,retryCount:3,retryDelay:1e3,pollRetryCount:2,loadTimeout:1e4,manifestLoadTimeout:1e4,preloadTime:30,softDecode:!1,bufferBehind:10,maxJumpDistance:3,startTime:0,useLowLatency:!0,targetLatency:10,maxLatency:20,allowedStreamTrackChange:!0,seiInTime:!1,manifestList:[],minSegmentsStartPlay:3,preferMMS:!1,preferMMSStreaming:!1,mseLowLatency:!0,fixerConfig:{forceFixLargeGap:!1,largeGapThreshold:5}},o),{},{media:s})}var gt=G(function o(){V(this,o),c(this,"version",0),c(this,"streams",[]),c(this,"isMaster",!0)}),Ue={Audio:"AUDIO",Video:"VIDEO",SubTitle:"SUBTITLE",ClosedCaptions:"CLOSED-CAPTIONS"},le={CLEAR_KEY:"org.w3.clearkey",FAIRPLAY:["urn:uuid:94ce86fb-07ff-4f43-adb8-93d2fa968ca2","com.apple.streamingkeydelivery"],WIDEVINE:["urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine.alpha","com.widevine"],PLAYREADY:["urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95","com.microsoft.playready"]};function Be(o){for(var s=[],t=0;t<o.length;t++)Array.isArray(o[t])?s=s.concat(Be(o[t])):s.push(o[t]);return s}var Ee=G(function o(){V(this,o),c(this,"id",0),c(this,"url",""),c(this,"default",!1),c(this,"autoSelect",!1),c(this,"forced",!1),c(this,"group",""),c(this,"name",""),c(this,"lang",""),c(this,"segments",[]),c(this,"endSN",0)}),St=function(o){me(t,o);var s=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return r=s.call.apply(s,[this].concat(i)),c(D(r),"mediaType",Ue.Audio),c(D(r),"channels",0),r}return G(t)}(Ee),yt=function(o){me(t,o);var s=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return r=s.call.apply(s,[this].concat(i)),c(D(r),"mediaType",Ue.SubTitle),r}return G(t)}(Ee),_t=G(function o(){V(this,o),c(this,"id",0),c(this,"bitrate",0),c(this,"width",0),c(this,"height",0),c(this,"name",""),c(this,"url",""),c(this,"audioCodec",""),c(this,"videoCodec",""),c(this,"textCodec",""),c(this,"audioGroup",""),c(this,"audioStreams",[]),c(this,"subtitleStreams",[]),c(this,"closedCaptionsStream",[])}),bt=G(function o(){V(this,o),c(this,"version",0),c(this,"url",""),c(this,"type",""),c(this,"startCC",0),c(this,"endCC",0),c(this,"startSN",0),c(this,"endSN",0),c(this,"totalDuration",0),c(this,"targetDuration",0),c(this,"partTargetDuration",0),c(this,"canSkipUntil",0),c(this,"canSkipDateRanges",!1),c(this,"skippedSegments",0),c(this,"canBlockReload",!1),c(this,"partHoldBack",0),c(this,"live",!0),c(this,"lowLatency",!1),c(this,"endPartIndex",0),c(this,"segments",[]),c(this,"dateRanges",{}),c(this,"skippedSegments",0)}),he=function(){function o(s){V(this,o),c(this,"sn",0),c(this,"cc",0),c(this,"url",""),c(this,"parentUrl",""),c(this,"title",""),c(this,"start",0),c(this,"duration",0),c(this,"dataTime",""),c(this,"key",null),c(this,"byteRange",null),c(this,"isInitSegment",!1),c(this,"initSegment",null),c(this,"isLast",!1),c(this,"hasAudio",!1),c(this,"hasVideo",!1),c(this,"independent",!1),c(this,"partIndex",0),this.parentUrl=s}return G(o,[{key:"end",get:function(){return this.start+this.duration}},{key:"setTrackExist",value:function(t,r){this.hasVideo=t,this.hasAudio=r}},{key:"setByteRange",value:function(t,r){this.byteRange=[0];var e=t.split("@");e.length===1&&r&&r.byteRange?(this.byteRange[0]=r.byteRange[1]||0,this.byteRange[0]&&(this.byteRange[0]+=1)):this.byteRange[0]=parseInt(e[1]),this.byteRange[1]=this.byteRange[0]+parseInt(e[0])-1}}]),o}(),Et=function(){function o(s){V(this,o),c(this,"method",""),c(this,"url",""),c(this,"iv",null),c(this,"keyFormat",""),c(this,"keyFormatVersions",""),s instanceof o&&(this.method=s.method,this.url=s.url,this.keyFormat=s.keyFormat,this.keyFormatVersions=s.keyFormatVersions,s.iv&&(this.iv=new Uint8Array(s.iv)))}return G(o,[{key:"clone",value:function(t){var r=new o(this);return t!=null&&r.setIVFromSN(t),r}},{key:"setIVFromSN",value:function(t){if(!this.iv&&this.method==="AES-128"&&typeof t=="number"&&this.url){this.iv=new Uint8Array(16);for(var r=12;r<16;r++)this.iv[r]=t>>8*(15-r)&255}}},{key:"isSegmentEncrypted",value:function(){var t=this.method;return t==="AES-128"}},{key:"isValidKeySystem",value:function(){var t=Be([le.CLEAR_KEY,le.FAIRPLAY,le.WIDEVINE,le.PLAYREADY]).indexOf(this.keyFormat)>-1;if(!t)return!1;var r=["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)>-1;return!!r}},{key:"isSupported",value:function(){return this.method?this.isSegmentEncrypted()?!0:!!this.isValidKeySystem():!1}}]),o}(),kt=/^#(EXT[^:]*)(?::(.*))?$/,Oe=/([^=]+)=(?:"([^"]*)"|([^",]*))(?:,|$)/g,wt=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,Tt=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/;function Lt(o){return o.split(/[\r\n]/).map(function(s){return s.trim()}).filter(Boolean)}function $e(o){var s=o.match(kt);if(!(!s||!s[1]))return[s[1].replace("EXT-X-",""),s[2]]}function q(o){for(var s={},t=Oe.exec(o);t;)s[t[1]]=t[2]||t[3],t=Oe.exec(o);return s}function ie(o,s){if(!s||!o||wt.test(o))return o;var t=Tt.exec(s);return t?o[0]==="/"?t[1]+o:t[1]+t[2]+o:o}var At={audio:[/^mp4a/,/^vorbis$/,/^opus$/,/^flac$/,/^[ae]c-3$/],video:[/^avc/,/^hev/,/^hvc/,/^vp0?[89]/,/^av1$/],text:[/^vtt$/,/^wvtt/,/^stpp/]};function ge(o,s){var t=At[o];if(!(!t||!s||!s.length)){for(var r=0;r<t.length;r++)for(var e=0;e<s.length;e++)if(t[r].test(s[e]))return s[e]}}function Dt(o,s){var t;if(s){for(var r in s)if(Object.prototype.hasOwnProperty.call(s,r)&&o[r]!==s[r]){t=r;break}}var e=null;o.DURATION&&(e=parseFloat(o.DURATION),Number.isFinite(e)?o._endDate&&(e=(o._endDate.getTime()-o._startDate.getTime())/1e3):e=null);var i=Pt(o.CUE||o["X-CUE"],{pre:!1,post:!1,once:!1});return!!o.ID&&!t&&Number.isFinite(o._startDate.getTime())&&(e===null||e>=0)&&(o.END_ON_NEXT!=="YES"||!!o.CLASS)&&(!o.CUE||!i.pre&&!i.post||i.pre!==i.post)&&(o.CLASS!=="com.apple.hls.interstitial"||"X-ASSET-URI"in o||"X-ASSET-LIST"in o)}function Pt(o,s){return(o?o.split(/[ ,]+/):[]).reduce(function(t,r){return t[r.toLowerCase()]=!0,t},s)}function It(o,s){for(var t=new gt,r=0,e,i=[],a=[];e=o[r++];){var n=$e(e);if(n){var l=J(n,2),u=l[0],h=l[1];if(u==="VERSION")t.version=parseInt(h);else if(u==="MEDIA"&&h){var m=q(h),p=void 0;switch(m.TYPE){case"AUDIO":p=new St;break;case"SUBTITLES":p=new yt;break;default:p=new Ee}p.url=ie(m.URI,s),p.default=m.DEFAULT==="YES",p.autoSelect=m.AUTOSELECT==="YES",p.group=m["GROUP-ID"],p.name=m.NAME,p.lang=m.LANGUAGE,m.CHANNELS&&(p.channels=Number(m.CHANNELS.split("/")[0]),Number.isNaN(p.channels)&&(p.channels=0)),m.TYPE==="AUDIO"&&m.URI&&i.push(p),m.TYPE==="SUBTITLES"&&a.push(p)}else if(u==="STREAM-INF"&&h){var d=new _t,f=q(h);if(d.bitrate=parseInt(f["AVERAGE-BANDWIDTH"]||f.BANDWIDTH),d.name=f.NAME,d.url=ie(o[r++],s),f.RESOLUTION){var y=f.RESOLUTION.split("x"),S=J(y,2),b=S[0],T=S[1];d.width=parseInt(b),d.height=parseInt(T)}if(f.CODECS){var N=f.CODECS.split(/[ ,]+/).filter(Boolean);d.videoCodec=ge("video",N),d.audioCodec=ge("audio",N),d.textCodec=ge("text",N)}d.audioGroup=f.AUDIO,d.subtitleGroup=f.SUBTITLES,t.streams.push(d)}}}return t.streams.forEach(function(w,L){w.id=L}),i.length&&(i.forEach(function(w,L){w.id=L}),t.streams.forEach(function(w){w.audioGroup&&(w.audioStreams=i.filter(function(L){return L.group===w.audioGroup}))})),a.length&&(a.forEach(function(w,L){w.id=L}),t.streams.forEach(function(w){w.subtitleGroup&&(w.subtitleStreams=a.filter(function(L){return L.group===w.subtitleGroup}))})),t}function Ot(o,s,t){var r=new bt;r.url=s;for(var e=new he(s),i=null,a=null,n=0,l=0,u=0,h=0,m,p=!1,d=0;m=o[h++];){if(m[0]!=="#"){if(r.lowLatency){l++;continue}e.sn=l,e.cc=u,e.url=ie(m,s),a&&(e.key=a.clone(l)),i&&(e.initSegment=i),r.segments.push(e),e=new he(s),l++;continue}var f=$e(m);if(f){var y=J(f,2),S=y[0],b=y[1];switch(S){case"VERSION":r.version=parseInt(b);break;case"PLAYLIST-TYPE":r.type=b==null?void 0:b.toUpperCase();break;case"TARGETDURATION":r.targetDuration=parseFloat(b);break;case"PART-INF":{t&&(r.lowLatency=!0);var T=q(b);T["PART-TARGET"]&&(r.partTargetDuration=parseFloat(T["PART-TARGET"]))}break;case"SERVER-CONTROL":{var N=q(b);r.canBlockReload=N["CAN-BLOCK-RELOAD"]==="YES",r.partHoldBack=parseFloat(N["PART-HOLD-BACK"]||0),r.canSkipUntil=parseFloat(N["CAN-SKIP-UNTIL"]||0),r.canSkipDateRanges=N["CAN-SKIP-DATERANGES"]==="YES"}break;case"ENDLIST":p=!0;break;case"MEDIA-SEQUENCE":l=r.startSN=parseInt(b);break;case"DISCONTINUITY-SEQUENCE":u=r.startCC=parseInt(b);break;case"DISCONTINUITY":u++;break;case"BYTERANGE":e.setByteRange(b,r.segments[r.segments.length-1]);break;case"PART":{if(!r.lowLatency)break;var w=q(b);e.duration=parseFloat(w.DURATION),e.independent=w.INDEPENDENT==="YES",e.sn=l,e.cc=u,e.partIndex=d,e.start=n,e.duration=parseFloat(w.DURATION),n+=e.duration,e.url=ie(w.URI,s),a&&(e.key=a.clone(l)),i&&(e.initSegment=i),r.segments.push(e),e=new he(s),d++}break;case"PRELOAD-HINT":break;case"PROGRAM-DATE-TIME":e.dataTime=b;break;case"EXTINF":{if(r.lowLatency){d=0;break}var L=b.split(","),U=J(L,2),Y=U[0],F=U[1];e.start=n,e.duration=parseFloat(Y),n+=e.duration,e.title=F}break;case"KEY":{var C=q(b);if(C.METHOD==="NONE"){a=null;break}if(a=new Et,a.method=C.METHOD,a.url=/^blob:/.test(C.URI)?C.URI:ie(C.URI,s),a.keyFormat=C.KEYFORMAT||"identity",a.keyFormatVersions=C.KEYFORMATVERSIONS,!a.isSupported())throw new Error("encrypt ".concat(C.METHOD,"/").concat(C.KEYFORMAT," is not supported"));if(C.IV){var j=C.IV.slice(2);j=(j.length&1?"0":"")+j,a.iv=new Uint8Array(j.length/2);for(var $=0,v=j.length/2;$<v;$++)a.iv[$]=parseInt(j.slice($*2,$*2+2),16)}}break;case"MAP":{var g=q(b);e.url=ie(g.URI,s),g.BYTERANGE&&e.setByteRange(g.BYTERANGE),e.isInitSegment=!0,e.sn=0,a&&(e.key=a.clone(0)),i=e,e=new he(s)}break;case"SKIP":{var _=q(b),A=parseInt(_["SKIPPED-SEGMENTS"],10);A<=Number.MAX_SAFE_INTEGER&&(r.skippedSegments+=A)}break;case"DATERANGE":{var k=q(b),O=r.dateRanges[k.ID];k._startDate=O?O._startDate:new Date(k["START-DATE"]);var B=(O==null?void 0:O._endDate)||new Date(k.END_DATE);Number.isFinite(B)&&(k._endDate=B),(Dt(k,O)||r.skippedSegments)&&(r.dateRanges[k.ID]=k)}break}}}r.segments=r.segments.filter(function(X){return X.duration!==0});var H=r.segments[r.segments.length-1];return H&&(p&&(H.isLast=!0),r.endSN=H.sn,r.endPartIndex=H.partIndex),p&&(r.live=!1),r.totalDuration=n,r.endCC=u,r}var ce=function(){function o(){V(this,o)}return G(o,null,[{key:"parse",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0,e=arguments.length>2?arguments[2]:void 0;if(!t.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var i=Lt(t);return o.isMediaPlaylist(t)?Ot(i,r,e):It(i,r)}},{key:"isMediaPlaylist",value:function(t){return t.includes("#EXTINF:")||t.includes("#EXT-X-TARGETDURATION:")}}]),o}(),Rt=function(){function o(s){var t=this;V(this,o),c(this,"_emitOnLoaded",function(l,u){var h=l.response,m=l.options,p=m||{},d=p.firstByteTime,f=p.startTime,y=p.endTime,S=p.contentLength,b=y-f;t.hls.emit(P.SPEED,{time:b,byteLength:S,url:u}),t.hls.emit(P.LOAD_COMPLETE,{url:u,elapsed:b||0}),t.hls.emit(P.TTFB,{url:u,responseUrl:h.url,elapsed:d-f}),t.hls.emit(P.LOAD_RESPONSE_HEADERS,{headers:h.headers,url:u})}),c(this,"_onLoaderRetry",function(l,u){t.hls.emit(I.LOAD_RETRY,{error:x.network(l),retryTime:u})}),this.hls=s,this._timer=null,this._useLowLatency=s.config.useLowLatency;var r=this.hls.config,e=r.retryCount,i=r.retryDelay,a=r.manifestLoadTimeout,n=r.fetchOptions;this._loader=new ne(M(M({},n),{},{responseType:"text",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._audioLoader=new ne(M(M({},n),{},{responseType:"text",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._subtitleLoader=new ne(M(M({},n),{},{responseType:"text",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry}))}return G(o,[{key:"load",value:function(){var s=R(E().mark(function r(e,i,a){var n,l,u,h,m,p,d,f,y,S,b,T,N,w,L,U,Y,F,C,j;return E().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return n=[this._loader.load(e)],i&&n.push(this._audioLoader.load(i)),a&&n.push(this._subtitleLoader.load(a)),v.prev=3,v.next=6,Promise.all(n);case 6:if(f=v.sent,y=J(f,3),S=y[0],b=y[1],T=y[2],S){v.next=13;break}return v.abrupt("return",[]);case 13:this._emitOnLoaded(S,e),l=S.data,m=S.response.url||e,i?(u=b==null?void 0:b.data,h=T==null?void 0:T.data,p=(b==null||(N=b.response)===null||N===void 0?void 0:N.url)||i,d=(T==null||(w=T.response)===null||w===void 0?void 0:w.url)||a,u&&this._emitOnLoaded(b,i),h&&this._emitOnLoaded(T,a)):(h=b==null?void 0:b.data,d=(b==null||(L=b.response)===null||L===void 0?void 0:L.url)||a,h&&this._emitOnLoaded(b,a)),v.next=22;break;case 19:throw v.prev=19,v.t0=v.catch(3),x.network(v.t0);case 22:if(U=this.hls.config.onPreM3U8Parse,v.prev=23,U&&(l=U(l)||l,u&&(u=U(u,!0)||u),h&&(h=U(h,!0)||h)),Y=ce.parse(l,m,this._useLowLatency),!(((j=Y)===null||j===void 0?void 0:j.live)===!1&&Y.segments&&!Y.segments.length)){v.next=28;break}throw new Error("empty segments list");case 28:u&&(F=ce.parse(u,p,this._useLowLatency)),h&&(C=ce.parse(h,d,this._useLowLatency)),v.next=35;break;case 32:throw v.prev=32,v.t1=v.catch(23),new x(Q.MANIFEST,Q.SUB_TYPES.HLS,v.t1);case 35:return Y&&(Y.isMaster?this.hls.emit(I.HLS_MANIFEST_LOADED,{playlist:Y}):this.hls.emit(I.HLS_LEVEL_LOADED,{playlist:Y})),v.abrupt("return",[Y,F,C]);case 37:case"end":return v.stop()}},r,this,[[3,19],[23,32]])}));function t(r,e,i){return s.apply(this,arguments)}return t}()},{key:"parseText",value:function(t,r){var e=this.hls.config.onPreM3U8Parse,i;try{var a;if(e&&(t=e(t)||t),i=ce.parse(t,r,this._useLowLatency),((a=i)===null||a===void 0?void 0:a.live)===!1&&i.segments&&!i.segments.length)throw new Error("empty segments list")}catch(n){throw new x(Q.MANIFEST,Q.SUB_TYPES.HLS,n)}return i&&(i.isMaster?this.hls.emit(I.HLS_MANIFEST_LOADED,{playlist:i}):this.hls.emit(I.HLS_LEVEL_LOADED,{playlist:i})),[i]}},{key:"poll",value:function(t,r,e,i,a,n){var l=this;clearTimeout(this._timer),n=n||3e3;var u=this.hls.config.pollRetryCount,h=function(){var m=R(E().mark(function p(){var d;return E().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:return clearTimeout(l._timer),y.prev=1,y.next=4,l.load(t,r,e);case 4:if(d=y.sent,d[0]){y.next=7;break}return y.abrupt("return");case 7:u=l.hls.config.pollRetryCount,i(d[0],d[1],d[2]),y.next=15;break;case 11:y.prev=11,y.t0=y.catch(1),u--,u<=0&&a(y.t0);case 15:l._timer=setTimeout(h,n);case 16:case"end":return y.stop()}},p,null,[[1,11]])}));return function(){return m.apply(this,arguments)}}();this._timer=setTimeout(h,n)}},{key:"stopPoll",value:function(){return clearTimeout(this._timer),this.cancel()}},{key:"cancel",value:function(){return Promise.all([this._loader.cancel(),this._audioLoader.cancel()])}}]),o}();function Fe(o,s,t){return s>t&&(t=s),Math.min(Math.max(o,s),t)}var Se=new ae("playlist"),Re=function(){function o(s,t,r){V(this,o),c(this,"live",void 0),c(this,"id",0),c(this,"bitrate",0),c(this,"width",0),c(this,"height",0),c(this,"name",""),c(this,"url",""),c(this,"audioCodec",""),c(this,"videoCodec",""),c(this,"textCodec",""),c(this,"startCC",0),c(this,"endCC",0),c(this,"startSN",0),c(this,"endSN",-1),c(this,"totalDuration",0),c(this,"targetDuration",0),c(this,"partTargetDuration",0),c(this,"canSkipUntil",0),c(this,"canSkipDateRanges",!1),c(this,"skippedSegments",0),c(this,"canBlockReload",!1),c(this,"partHoldBack",0),c(this,"lowLatency",!1),c(this,"endPartIndex",0),c(this,"snDiff",null),c(this,"segments",[]),c(this,"audioStreams",[]),c(this,"subtitleStreams",[]),c(this,"closedCaptions",[]),c(this,"currentAudioStream",null),c(this,"currentSubtitleStream",null),this.update(this._setLLPlaybackPoint(s),t,r)}return G(o,[{key:"lastSegment",get:function(){return this.segments.length?this.segments[this.segments.length-1]:null}},{key:"segmentDuration",get:function(){var t;return this.targetDuration||((t=this.segments[0])===null||t===void 0?void 0:t.duration)||0}},{key:"liveEdge",get:function(){return this.endTime},set:function(t){this.endTime=t}},{key:"endTime",get:function(){var t;return((t=this.lastSegment)===null||t===void 0?void 0:t.end)||0},set:function(t){var r=this.lastSegment;r&&(r.duration=t-r.start)}},{key:"currentSubtitleEndSn",get:function(){var t;return((t=this.currentSubtitleStream)===null||t===void 0?void 0:t.endSN)||0}},{key:"clearOldSegment",value:function(t,r){return this.currentAudioStream&&this._clearSegments(t,r),this._clearSegments(t,r)}},{key:"getAudioSegment",value:function(t){if(!(!t||!this.currentAudioStream)){var r=t.sn-this.snDiff;return this.currentAudioStream.segments.find(function(e){return e.sn===r})}}},{key:"update",value:function(t,r){this.url=t.url,Array.isArray(t.segments)?((this.live===null||this.live===void 0)&&(this.live=t.live),this._updateSegments(t,this),this.startCC=t.startCC,this.endCC=t.endCC,this.startSN=t.startSN,this.endSN=t.endSN||-1,this.totalDuration=t.totalDuration,this.targetDuration=t.targetDuration,this.live=t.live,this.lowLatency=t.lowLatency,this.canBlockReload=t.canBlockReload,this.canSkipDateRanges=t.canSkipDateRanges,this.canSkipUntil=t.canSkipUntil,this.partHoldBack=t.partHoldBack,this.partTargetDuration=t.partTargetDuration,this.skippedSegments=t.skippedSegments,this.endPartIndex=t.endPartIndex,r&&this.currentAudioStream&&Array.isArray(r.segments)&&(this._updateSegments(r,this.currentAudioStream),(this.snDiff===null||this.snDiff===void 0)&&t.segments.length&&r.segments.length&&(this.snDiff=t.segments[0].sn-r.segments[0].sn))):(this.id=t.id,this.bitrate=t.bitrate,this.width=t.width,this.height=t.height,this.name=t.name,this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.textCodec=t.textCodec,this.audioStreams=t.audioStreams,this.subtitleStreams=t.subtitleStreams,!this.currentAudioStream&&this.audioStreams.length&&(this.currentAudioStream=this.audioStreams.find(function(e){return e.default})||this.audioStreams[0]),!this.currentSubtitleStream&&this.subtitleStreams.length&&(this.currentSubtitleStream=this.subtitleStreams.find(function(e){return e.default})||this.subtitleStreams[0]))}},{key:"updateSubtitle",value:function(t){var r=this;if(t&&this.currentSubtitleStream&&Array.isArray(t.segments)){var e=this._updateSegments(t,this.currentSubtitleStream),i=this.currentSubtitleStream.segments;if(i.length>100&&(this.currentSubtitleStream.segments=i.slice(100)),!!e)return e.map(function(a){return{sn:a.sn,url:a.url,duration:a.duration,start:a.start,end:a.end,lang:r.currentSubtitleStream.lang}})}}},{key:"switchSubtitle",value:function(t){var r=this.subtitleStreams.find(function(i){return i.lang===t}),e=this.currentSubtitleStream;r&&(this.currentSubtitleStream=r,e.segments=[])}},{key:"_setLLPlaybackPoint",value:function(t){if(!t.lowLatency||!t.segments.length)return t;for(var r=t.totalDuration-t.partHoldBack,e=t.segments,i=0,a=0,n=e.length;a<n;a++)e[a].start<=r&&e[a].independent&&(i=a);var l=e.slice(i),u=0;return l.forEach(function(h){h.start=u,u=h.end}),t.segments=l,t.totalDuration=u,t.startSN=l[0].sn,t.startCC=l[0].cc,Se.log("set ll-hls playback point: SN=".concat(t.startSN," partIndex=").concat(l[0].partIndex,", duration=").concat(u)),t}},{key:"_clearSegments",value:function(t,r){for(var e=0,i=this.segments,a=0,n=i.length;a<n;a++)if(i[a].end>=t){e=a;break}return e>r&&(e=r),e&&(this.segments=this.segments.slice(e),this.currentAudioStream&&(this.currentAudioStream.segments=this.currentAudioStream.segments.slice(e))),r-e}},{key:"_updateSegments",value:function(t,r){var e=r.segments;if(this.live){var i,a=t.lowLatency,n=e[e.length-1],l=(i=n==null?void 0:n.sn)!==null&&i!==void 0?i:-1,u=(n==null?void 0:n.partIndex)||0,h=l<t.endSN&&t.segments.length;if(a&&(h=h||u<t.endPartIndex),h){Se.log("update segments: endSN:".concat(l,", partIndex:").concat(u," --> endSN:").concat(t.endSN,", partIndex:").concat(t.endPartIndex));var m=t.segments.findIndex(function(S){return S.sn===l&&S.partIndex===u}),p=m<0?t.segments:t.segments.slice(m+1);if(e.length&&p.length){var d=n.end,f=d;p.forEach(function(S){S.start=d,d=S.end}),Se.log("liveEdge: ".concat(f," -> ").concat(d));var y=(n==null?void 0:n.cc)||-1;y>p[0].cc&&p.forEach(function(S){return S.cc+=y})}return r.endSN=t.endSN,r.segments=e.concat(p),p}}else r.segments=t.segments}}]),o}(),Ct=function(){function o(s){V(this,o),c(this,"streams",[]),c(this,"currentStream",null),c(this,"dvrWindow",0),c(this,"_segmentPointer",-1),this.hls=s}return G(o,[{key:"lowLatency",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.lowLatency}},{key:"lastSegment",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.lastSegment}},{key:"currentSegment",get:function(){var t;return(t=this.currentSegments)===null||t===void 0?void 0:t[this._segmentPointer]}},{key:"nextSegment",get:function(){var t;return(t=this.currentSegments)===null||t===void 0?void 0:t[this._segmentPointer+1]}},{key:"currentSegments",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.segments}},{key:"currentSubtitleEndSn",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.currentSubtitleEndSn}},{key:"liveEdge",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.liveEdge},set:function(t){this.currentStream&&(this.currentStream.liveEdge=t)}},{key:"totalDuration",get:function(){var t;return((t=this.currentStream)===null||t===void 0?void 0:t.totalDuration)||0}},{key:"seekRange",get:function(){var t=this.currentSegments;if(!(!t||!t.length))return[t[0].start,t[t.length-1].end]}},{key:"nbSegments",get:function(){var t;return((t=this.currentSegments)===null||t===void 0?void 0:t.length)||0}},{key:"isEmpty",get:function(){var t;return!((t=this.currentSegments)!==null&&t!==void 0&&t.length)}},{key:"isLive",get:function(){var t;return(t=this.currentStream)===null||t===void 0?void 0:t.live}},{key:"hadSegmentLoaded",get:function(){return this._segmentPointer!==-1}},{key:"hasSubtitle",get:function(){var t;return!!((t=this.currentStream)!==null&&t!==void 0&&t.currentSubtitleStream)}},{key:"getAudioSegment",value:function(t){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.getAudioSegment(t)}},{key:"moveSegmentPointer",value:function(t){var r;t==null&&(t=this._segmentPointer+1),this._segmentPointer=Fe(t,-1,(r=this.currentSegments)===null||r===void 0?void 0:r.length)}},{key:"reset",value:function(){this.streams=[],this.currentStream=null,this.dvrWindow=0,this._segmentPointer=-1}},{key:"getSegmentByIndex",value:function(t){var r;return(r=this.currentSegments)===null||r===void 0?void 0:r[t]}},{key:"setNextSegmentByIndex",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._segmentPointer=t-1}},{key:"setNextSegmentBySN",value:function(){var t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=(t=this.currentSegments)===null||t===void 0?void 0:t.findIndex(function(i){return i.sn===r});return e!==-1&&this.setNextSegmentByIndex(e+1),e}},{key:"findSegmentIndexByTime",value:function(t){var r=this.currentSegments;if(r){for(var e=0,i=r.length,a;e<i;e++)if(a=r[e],t>=a.start&&t<a.end)return e;var n=r[r.length-1];if(Math.abs(t-(n==null?void 0:n.end))<.2)return r.length-1}}},{key:"upsertPlaylist",value:function(t,r,e){var i=this;if(t){if(t.isMaster)this.streams.length=t.streams.length,t.streams.filter(function(u){return u.url}).forEach(function(u,h){i.streams[h]?i.streams[h].update(u):i.streams[h]=new Re(u)}),this.currentStream=this.streams[0];else if(Array.isArray(t.segments)){var a=this.currentStream;if(a){a.update(t,r,e);var n=a.updateSubtitle(e);n&&this.hls.emit(I.SUBTITLE_SEGMENTS,{list:n})}else this.reset(),this.currentStream=this.streams[0]=new Re(t,r,e)}var l=this.currentStream;l&&this.hls.isLive&&!this.dvrWindow&&(this.dvrWindow=this.currentSegments.reduce(function(u,h){return u+=h.duration,u},0))}}},{key:"updateSegmentsRanges",value:function(t,r){var e,i=(e=this.currentSegments)===null||e===void 0?void 0:e.filter(function(a){return a.sn>=t});i.forEach(function(a){a.start=r,r=a.end})}},{key:"switchSubtitle",value:function(t){var r;(r=this.currentStream)===null||r===void 0||r.switchSubtitle(t)}},{key:"clearOldSegment",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:50,r=this.currentStream;if(!(!this.dvrWindow||!r)){var e=r.endTime-this.dvrWindow;if(!(e<=0)){var i=r.segments;i.length<=t||(this._segmentPointer=r.clearOldSegment(e,this._segmentPointer))}}}},{key:"checkSegmentTrackChange",value:function(t,r){var e=this.findSegmentIndexByTime(t),i=this.getSegmentByIndex(e);if(i&&!(!i.hasAudio&&!i.hasVideo)){if(r!==2&&i.hasAudio&&i.hasVideo)return i;if(!(i.end-t>.3)){var a=this.getSegmentByIndex(e+1);if(a&&!(!a.hasAudio&&!a.hasVideo)&&(a.hasAudio!==i.hasAudio||a.hasVideo!==i.hasVideo))return a}}}},{key:"feedbackLiveEdge",value:function(t,r){var e,i=this.currentSegments;if(i){var a=((e=this.lastSegment)===null||e===void 0?void 0:e.sn)===t.sn;if(a){this.liveEdge=r;return}this.updateSegmentsRanges(t.sn+1,r)}}}]),o}(),Mt=function(){function o(s){var t=this;V(this,o),c(this,"error",null),c(this,"_emitOnLoaded",function(l,u){var h=l.data,m=l.response,p=l.options,d=p||{},f=d.firstByteTime,y=d.startTime,S=d.endTime,b=d.contentLength,T=S-y;t._bandwidthService.addRecord(b||h.byteLength,T),t.hls.emit(P.SPEED,{time:T,byteLength:b,url:u}),t.hls.emit(P.LOAD_COMPLETE,{url:u,elapsed:T||0}),t.hls.emit(P.TTFB,{url:u,responseUrl:m.url,elapsed:f-y}),t.hls.emit(P.LOAD_RESPONSE_HEADERS,{headers:m.headers,url:u})}),c(this,"_onLoaderRetry",function(l,u){t.hls.emit(P.LOAD_RETRY,{error:x.network(l),retryTime:u})}),this.hls=s,this._bandwidthService=new He,this._mapCache={},this._keyCache={};var r=this.hls.config,e=r.retryCount,i=r.retryDelay,a=r.loadTimeout,n=r.fetchOptions;this._segmentLoader=new ne(M(M({},n),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._audioSegmentLoader=new ne(M(M({},n),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry})),this._keyLoader=new ne(M(M({},n),{},{responseType:"arraybuffer",retry:e,retryDelay:i,timeout:a,onRetryError:this._onLoaderRetry}))}return G(o,[{key:"speedInfo",value:function(){return{speed:this._bandwidthService.getLatestSpeed(),avgSpeed:this._bandwidthService.getAvgSpeed()}}},{key:"load",value:function(t,r,e){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:e,a=[];return t&&(a[0]=this.loadVideoSegment(t,e)),r&&(a[1]=this.loadAudioSegment(r,i)),Promise.all(a)}},{key:"loadVideoSegment",value:function(t,r){return this._loadSegment(this._segmentLoader,t,r)}},{key:"loadAudioSegment",value:function(t,r){return this._loadSegment(this._audioSegmentLoader,t,r)}},{key:"_loadSegment",value:function(){var s=R(E().mark(function r(e,i,a){var n=this,l,u,h,m,p,d,f,y,S,b,T,N,w,L,U;return E().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:return f=[],this.hls.emit(P.LOAD_START,{url:i.url}),f[0]=e.load(i.url),a&&i.initSegment&&(S=i.initSegment.url,u=this._mapCache[S],u||(this.hls.emit(P.LOAD_START,{url:S}),f[1]=e.load(S).then(function(C){if(C){var j=Object.keys(n._mapCache);j>30&&(n._mapCache={}),u=n._mapCache[S]=C.data,n._emitOnLoaded(C,S)}})),b=(y=i.initSegment.key)===null||y===void 0?void 0:y.url,b&&(d=i.initSegment.key.iv,p=this._keyCache[b],p||(this.hls.emit(P.LOAD_START,{url:b}),f[2]=this._keyLoader.load(b).then(function(C){C&&(p=n._keyCache[b]=C.data,n._emitOnLoaded(C,b))})))),T=(l=i.key)===null||l===void 0?void 0:l.url,T&&i.key.isSegmentEncrypted()&&(m=i.key.iv,h=this._keyCache[T],h||(this.hls.emit(P.LOAD_START,{url:T}),f[3]=this._keyLoader.load(T).then(function(C){C&&(h=n._keyCache[T]=C.data,n._emitOnLoaded(C,T))}))),F.next=8,Promise.all(f);case 8:if(N=F.sent,w=J(N,1),L=w[0],L){F.next=13;break}return F.abrupt("return");case 13:return U=L.data,this._emitOnLoaded(L,i.url),F.abrupt("return",{data:U,map:u,key:h,mapKey:p,keyIv:m,mapKeyIv:d});case 16:case"end":return F.stop()}},r,this)}));function t(r,e,i){return s.apply(this,arguments)}return t}()},{key:"reset",value:function(){this.error=null,this._mapCache={},this._keyCache={},this._bandwidthService.reset()}},{key:"cancel",value:function(){var s=R(E().mark(function r(){return E().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Promise.all([this._keyLoader.cancel(),this._segmentLoader.cancel(),this._audioSegmentLoader.cancel()]);case 2:case"end":return i.stop()}},r,this)}));function t(){return s.apply(this,arguments)}return t}()}]),o}(),K=new ae("hls"),se=function(o){me(t,o);var s=ve(t);function t(r){var e;return V(this,t),e=s.call(this),c(D(e),"version",t.version),c(D(e),"media",null),c(D(e),"config",null),c(D(e),"_manifestLoader",null),c(D(e),"_segmentLoader",null),c(D(e),"_playlist",null),c(D(e),"_bufferService",null),c(D(e),"_gapService",null),c(D(e),"_seiService",null),c(D(e),"_stats",null),c(D(e),"_prevSegSn",null),c(D(e),"_prevSegCc",null),c(D(e),"_tickTimer",null),c(D(e),"_tickInterval",500),c(D(e),"_segmentProcessing",!1),c(D(e),"_reloadOnPlay",!1),c(D(e),"_switchUrlOpts",null),c(D(e),"_isProcessQuotaExceeded",!1),c(D(e),"_loadSegment",R(E().mark(function i(){var a,n,l,u,h,m,p,d,f;return E().wrap(function(S){for(;;)switch(S.prev=S.next){case 0:if(!(e._segmentProcessing||!e.media)){S.next=2;break}return S.abrupt("return");case 2:if(a=e._playlist,n=a.nextSegment,l=a.lastSegment,u=D(e),h=u.config,m=.016,p=Math.min(Math.max((l==null?void 0:l.duration)-m/2||0,m),.1),n){S.next=8;break}return S.abrupt("return");case 8:if(e.isLive){S.next=18;break}if(d=e.bufferInfo(),e.media.paused&&!e.media.currentTime&&(d=e.bufferInfo(d.nextStart||.5)),f=Math.abs(d.end-e.media.duration)<p,!(d.remaining>=h.preloadTime||f)){S.next=15;break}return e._tryEos(),S.abrupt("return");case 15:if(!(h.preferMMSStreaming&&!e._bufferService.msStreaming)){S.next=17;break}return S.abrupt("return");case 17:!e._urlSwitching&&e._prevSegSn!==n.sn-1&&d.end&&Math.abs(n.start-d.end)>1&&e._playlist.setNextSegmentByIndex(e._playlist.findSegmentIndexByTime(d.end+.1));case 18:return S.abrupt("return",e._loadSegmentDirect());case 19:case"end":return S.stop()}},i)}))),c(D(e),"_onLoadeddata",function(){e.isLive&&!e.config.mseLowLatency&&e.media.duration!==1/0&&e._bufferService.updateDuration(1/0).catch(function(i){})}),c(D(e),"_onPlay",R(E().mark(function i(){return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!(e.media.seeking&&e.media.currentTime===0)){n.next=3;break}return K.debug("replay currentTime 0, return"),n.abrupt("return");case 3:if(clearTimeout(e._disconnectTimer),!e._reloadOnPlay){n.next=9;break}e._reloadOnPlay=!1,e.replay(!0),n.next=12;break;case 9:return n.next=11,e._loadSegment();case 11:e._startTick();case 12:case"end":return n.stop()}},i)}))),c(D(e),"_onPause",function(){if(e.isLive){if(!e._reloadOnPlay){var i=e.config.disconnectTime;if(i==null&&(i=e._playlist.dvrWindow),!Number.isFinite(i))return;clearTimeout(e._disconnectTimer),e._disconnectTimer=setTimeout(function(){e._reloadOnPlay=!0,e._clear()},i||0)}}else e._stopTick()}),c(D(e),"_onSeeking",R(E().mark(function i(){var a,n,l,u,h,m,p;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(e.media){f.next=2;break}return f.abrupt("return");case 2:if(e._onCheckQuotaExceeded(),a=e.media.currentTime,n=e._playlist.seekRange,!n){f.next=10;break}if(l=Fe(a,n[0],e.isLive?n[1]:e.media.duration),!(l>=0&&Math.abs(a-l)>=.1)){f.next=10;break}return e.media.currentTime=l,f.abrupt("return");case 10:if(u=e._playlist.currentSegment,h=z.info(z.get(e.media),a,.1),!u){f.next=17;break}if(!(h.end&&Math.abs(h.end-u.end)<.2)){f.next=15;break}return f.abrupt("return");case 15:if(!(e.isLive&&h.end)){f.next=17;break}return f.abrupt("return");case 17:if(m=e._playlist.findSegmentIndexByTime(a),p=e._playlist.getSegmentByIndex(m),!(m==null||!p||e._segmentProcessing&&p===e._playlist.nextSegment)){f.next=21;break}return f.abrupt("return");case 21:return K.debug("seek to",a,p),e._playlist.setNextSegmentByIndex(m),e._stopTick(),f.next=26,e._segmentLoader.cancel();case 26:if(e._segmentProcessing=!1,!(!h.end||e.isLive)){f.next=30;break}return f.next=30,e._loadSegmentDirect(!0);case 30:e._startTick();case 31:case"end":return f.stop()}},i)}))),c(D(e),"_onTimeupdate",function(){if(e.media){var i=e.config;if(i.isLive&&i.maxLatency&&i.targetLatency&&e.media){var a=e._playlist.liveEdge;if(!a)return;var n=a-e.media.currentTime;n>=i.maxLatency&&(K.debug("latency jump, currentTime:".concat(e.media.currentTime,", liveEdge:").concat(a,",  latency=").concat(n)),e.media.currentTime=a-i.targetLatency)}if(i.seiInTime){var l;(l=e._seiService)===null||l===void 0||l.throw(e.media.currentTime)}e.config.allowedStreamTrackChange&&!e.config.softDecode&&e._checkStreamTrackChange(e.media.currentTime)}}),c(D(e),"_tick",function(){if(e.media){e._startTick();var i=e.media,a=z.get(i),n=e._segmentLoader.error;if(e._onCheckQuotaExceeded(),e._isProcessQuotaExceeded&&(e._bufferService.isFull()||(e._isProcessQuotaExceeded=!1,e._segmentProcessing=!1)),n){var l=.5;(!i.readyState||e.bufferInfo(l).remaining<1)&&(n.fatal=!0,e._emitError(x.network(n)));return}z.end(a)>=.1&&i.readyState&&(Ye(i)?(e._loadSegment(),e._gapService&&e._gapService.do(i,e.config.maxJumpDistance,e.isLive)):i.readyState<2&&e._gapService&&e._gapService.do(i,e.config.maxJumpDistance,i.currentTime?e.isLive:!0)),e.isLive||e._tryEos()}}),e.config=r=pt(r),e.media=e.config.media,e._manifestLoader=new Rt(D(e)),e._segmentLoader=new Mt(D(e)),e._playlist=new Ct(D(e)),e._bufferService=new vt(D(e)),r.seiInTime&&(e._seiService=new je(D(e))),r.softDecode||(e._gapService=new xe),e._stats=new Ke(D(e),9e4),e.media.addEventListener("loadeddata",e._onLoadeddata),e.media.addEventListener("play",e._onPlay),e.media.addEventListener("pause",e._onPause),e.media.addEventListener("seeking",e._onSeeking),e.media.addEventListener("timeupdate",e._onTimeupdate),e}return G(t,[{key:"isLive",get:function(){return this._playlist.isLive}},{key:"streams",get:function(){return this._playlist.streams}},{key:"currentStream",get:function(){return this._playlist.currentStream}},{key:"hasSubtitle",get:function(){return this._playlist.hasSubtitle}},{key:"totalDuration",get:function(){return this._playlist.totalDuration}},{key:"baseDts",get:function(){var e;return(e=this._bufferService)===null||e===void 0?void 0:e.baseDts}},{key:"abrSwitchPoint",get:function(){var e=this._urlSwitching?this._playlist.currentSegment:this._playlist.nextSegment;return e?e.start+e.duration/2:null}},{key:"speedInfo",value:function(){return this._segmentLoader.speedInfo()}},{key:"bufferInfo",value:function(){var e,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:.1;return z.info(z.get(this.media),(e=this.media)===null||e===void 0?void 0:e.currentTime,i)}},{key:"getStats",value:function(){return this._stats.getStats()}},{key:"playbackQuality",value:function(){return Xe(this.media)}},{key:"load",value:function(){var r=R(E().mark(function i(){var a,n,l,u=arguments;return E().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return a=u.length>0&&u[0]!==void 0?u[0]:"",n=u.length>1&&u[1]!==void 0?u[1]:{},l=typeof n=="boolean"?n:!!(n!=null&&n.reuseMse),oe(n)==="object"&&n!==null&&n!==void 0&&n.clearSwitchStatus&&(this._urlSwitching=!1,this._switchUrlOpts=null,this.config.startTime=void 0),a&&(this.config.url=a),a=this.config.url,m.next=8,this._reset(l);case 8:return m.next=10,this._loadData(a);case 10:this._startTick();case 11:case"end":return m.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_loadData",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m,p,d,f,y,S,b,T,N;return E().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:try{a&&(a=a.trim())}catch{}if(a){L.next=3;break}throw this._emitError(new x(Q.OTHER,Q.SUB_TYPES.OPTION,null,null,"m3u8 url is missing"));case 3:return L.next=5,this._loadM3U8(a);case 5:if(n=L.sent,l=this._playlist.currentStream,!this._urlSwitching){L.next=23;break}if(!this.isLive){L.next=14;break}u=this._playlist.setNextSegmentBySN(this._prevSegSn),K.log("segment nb=".concat(this._prevSegSn," index of ").concat(u," in the new playlist")),u===-1&&(this._prevSegCc=null,this._prevSegSn=null),L.next=23;break;case 14:if(l.bitrate===0&&(h=this._switchUrlOpts)!==null&&h!==void 0&&h.bitrate&&(l.bitrate=(d=this._switchUrlOpts)===null||d===void 0?void 0:d.bitrate),f=typeof((m=this._switchUrlOpts)===null||m===void 0?void 0:m.startTime)=="number"?(p=this._switchUrlOpts)===null||p===void 0?void 0:p.startTime:this._getSeamlessSwitchPoint(),this.config.startTime=f,y=this._playlist.findSegmentIndexByTime(f),S=this._playlist.getSegmentByIndex(y+1),!S){L.next=23;break}return b=S.start,L.next=23,this._bufferService.removeBuffer(b);case 23:if(n){L.next=25;break}return L.abrupt("return");case 25:if(!this.isLive){L.next=36;break}if(this._bufferService.setLiveSeekableRange(0,4294967295),K.log("totalDuration first time got:",this._playlist.totalDuration),K.log("nb segments got:",this._playlist.nbSegments),this.config.targetLatency<this._playlist.totalDuration&&(this.config.targetLatency=this._playlist.totalDuration,this.config.maxLatency=1.5*this.config.targetLatency),n.isMaster||this._pollM3U8(a),!(this._playlist.nbSegments<this.config.minSegmentsStartPlay)){L.next=33;break}return L.abrupt("return");case 33:return L.next=35,this._loadSegment();case 35:return L.abrupt("return");case 36:return L.next=38,this._bufferService.updateDuration(l.totalDuration);case 38:return T=this.config.startTime,T&&((N=this._switchUrlOpts)!==null&&N!==void 0&&N.seamless||(this.media.currentTime=T),this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(T)||0)),L.next=42,this._loadSegment();case 42:case"end":return L.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"replay",value:function(){var r=R(E().mark(function i(a){return E().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return this.config.startTime=0,this._urlSwitching=!1,this._switchUrlOpts=null,l.next=5,this.load();case 5:return this._reloadOnPlay=!1,l.abrupt("return",this.media.play(!a));case 7:case"end":return l.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchURL",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m,p,d,f=arguments;return E().wrap(function(S){for(;;)switch(S.prev=S.next){case 0:n=f.length>1&&f[1]!==void 0?f[1]:{},l={seamless:!1,startTime:0,bitrate:0},S.t0=oe(n),S.next=S.t0==="number"?5:S.t0==="boolean"?7:S.t0==="object"?9:11;break;case 5:return n={startTime:n},S.abrupt("break",12);case 7:return n={seamless:n},S.abrupt("break",12);case 9:for(u in n)(n[u]===void 0||n[u]===null)&&delete n[u];return S.abrupt("break",12);case 11:throw"unsupported switchURL args: ".concat(n);case 12:if(n=Object.assign({},l,n),h=n,m=h.seamless,p=h.startTime,this.config.url=a,this.config.startTime=p,this._switchUrlOpts=n,m){S.next=38;break}if(S.prev=18,!this.config.softDecode){S.next=23;break}S.t1=this.load(a),S.next=26;break;case 23:return S.next=25,this.load(a);case 25:S.t1=S.sent;case 26:d=S.t1,S.next=33;break;case 29:throw S.prev=29,S.t2=S.catch(18),this.emit(I.SWITCH_URL_FAILED,S.t2),S.t2;case 33:return this._reloadOnPlay=!1,d&&this.emit(I.SWITCH_URL_SUCCESS,{url:a}),S.abrupt("return",this.media.play(!0));case 38:return this._urlSwitching=!0,this.isLive||(this._prevSegSn=null,this._prevSegCc=null),this._playlist.reset(),this._bufferService.seamlessSwitch(),S.next=44,this._clear();case 44:return S.next=46,this._loadData(a);case 46:this._startTick();case 47:this._switchUrlOpts=null;case 48:case"end":return S.stop()}},i,this,[[18,29]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchStream",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m,p=arguments;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(n=p.length>1&&p[1]!==void 0?p[1]:!0,l=this.currentStream,u=this.streams,!(!l||l.id===a||!u||u.length<2)){f.next=5;break}return f.abrupt("return");case 5:if(h=u.find(function(y){return y.id===a}),h){f.next=8;break}return f.abrupt("return");case 8:return f.prev=8,f.next=11,this._clear();case 11:if(!n){f.next=14;break}return f.next=14,this._bufferService.clearAllBuffer();case 14:f.next=19;break;case 16:throw f.prev=16,f.t0=f.catch(8),this._emitError(x.create(f.t0));case 19:if(l.currentAudioStream&&h.audioStreams.length>2&&(m=l.currentAudioStream.id,h.currentAudioStream=h.audioStreams.find(function(y){return y.id===m})||h.currentAudioStream),this._playlist.currentStream=h,f.prev=21,!(this.isLive||!h.segments.length)){f.next=25;break}return f.next=25,this._refreshM3U8();case 25:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,f.next=29,this._loadSegmentDirect();case 29:f.next=35;break;case 31:throw f.prev=31,f.t1=f.catch(21),this._playlist.currentStream=l,f.t1;case 35:return this._startTick(),f.abrupt("return",h);case 37:case"end":return f.stop()}},i,this,[[8,16],[21,31]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchAudioStream",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m=arguments;return E().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(n=m.length>1&&m[1]!==void 0?m[1]:!0,l=this.currentStream,l){d.next=4;break}return d.abrupt("return");case 4:if(u=l.currentAudioStream,!(!u||u.id===a||l.audioStreams.length<2)){d.next=7;break}return d.abrupt("return");case 7:if(h=l.audioStreams.find(function(f){return f.id===a}),h){d.next=10;break}return d.abrupt("return");case 10:return d.prev=10,d.next=13,this._clear();case 13:if(!n){d.next=16;break}return d.next=16,this._bufferService.clearAllBuffer();case 16:d.next=21;break;case 18:throw d.prev=18,d.t0=d.catch(10),this._emitError(x.create(d.t0));case 21:if(l.currentAudioStream=h,d.prev=22,!(this.isLive||!h.segments.length)){d.next=26;break}return d.next=26,this._refreshM3U8();case 26:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,d.next=30,this._loadSegmentDirect();case 30:d.next=36;break;case 32:throw d.prev=32,d.t1=d.catch(22),l.currentAudioStream=u,d.t1;case 36:return this._startTick(),d.abrupt("return",h);case 38:case"end":return d.stop()}},i,this,[[10,18],[22,32]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"switchSubtitleStream",value:function(){var r=R(E().mark(function i(a){return E().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return this._playlist.switchSubtitle(a),l.next=3,this._manifestLoader.stopPoll();case 3:return l.next=5,this._refreshM3U8();case 5:case"end":return l.stop()}},i,this)}));function e(i){return r.apply(this,arguments)}return e}()},{key:"detachMedia",value:function(){var r=R(E().mark(function i(){return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!this._bufferService){n.next=3;break}return n.next=3,this._bufferService.detachMedia();case 3:case"end":return n.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"destroy",value:function(){var r=R(E().mark(function i(){var a;return E().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(this.media){l.next=2;break}return l.abrupt("return");case 2:return this.removeAllListeners(),this._playlist.reset(),this._segmentLoader.reset(),(a=this._seiService)===null||a===void 0||a.reset(),this.media.removeEventListener("loadeddata",this._onLoadeddata),this.media.removeEventListener("play",this._onPlay),this.media.removeEventListener("pause",this._onPause),this.media.removeEventListener("seeking",this._onSeeking),this.media.removeEventListener("timeupdate",this._onTimeupdate),l.next=13,Promise.all([this._clear(),this._bufferService.destroy()]);case 13:this.media=null;case 14:case"end":return l.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_loadM3U8",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m,p,d;return E().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:if(y.prev=0,h=(l=this.config.manifestList)===null||l===void 0||(u=l.filter(function(S){return S.url===a})[0])===null||u===void 0?void 0:u.manifest,!h){y.next=6;break}y.t0=this._manifestLoader.parseText(h,a),y.next=9;break;case 6:return y.next=8,this._manifestLoader.load(a);case 8:y.t0=y.sent;case 9:m=y.t0,p=J(m,1),n=p[0],y.next=17;break;case 14:throw y.prev=14,y.t1=y.catch(0),this._emitError(x.create(y.t1));case 17:if(n){y.next=19;break}return y.abrupt("return");case 19:if(this._playlist.upsertPlaylist(n),!n.isMaster){y.next=24;break}return(d=this._playlist.currentStream.subtitleStreams)!==null&&d!==void 0&&d.length&&this.emit(I.SUBTITLE_PLAYLIST,{list:this._playlist.currentStream.subtitleStreams}),y.next=24,this._refreshM3U8();case 24:return this.emit(I.STREAM_PARSED),y.abrupt("return",n);case 26:case"end":return y.stop()}},i,this,[[0,14]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"_refreshM3U8",value:function(){var e,i,a=this,n=this._playlist.currentStream;if(!n||!n.url)throw this._emitError(x.create(null,null,new Error("m3u8 url is not defined")));var l=n.url,u=(e=n.currentAudioStream)===null||e===void 0?void 0:e.url,h=(i=n.currentSubtitleStream)===null||i===void 0?void 0:i.url;return this._manifestLoader.load(l,u,h).then(function(m){var p=J(m,3),d=p[0],f=p[1],y=p[2];d&&(a._playlist.upsertPlaylist(d,f,y),a.isLive&&a._pollM3U8(l,u,h))}).catch(function(m){throw a._emitError(x.create(m))})}},{key:"_pollM3U8",value:function(e,i,a){var n=this,l=this._playlist.isEmpty,u;if(this._playlist.lowLatency)u=(this._playlist.currentStream.partTargetDuration||0)*1e3;else{var h;u=(((h=this._playlist.lastSegment)===null||h===void 0?void 0:h.duration)||0)*1e3}this._manifestLoader.poll(e,i,a,function(m,p,d){n._playlist.upsertPlaylist(m,p,d),n._playlist.clearOldSegment();var f=m&&l&&!n._playlist.isEmpty;(f||!n._playlist.hadSegmentLoaded&&n._playlist.nbSegments>=n.config.minSegmentsStartPlay)&&n._loadSegment(),l&&(l=n._playlist.isEmpty)},function(m){n._emitError(x.create(m))},u)}},{key:"_loadSegmentDirect",value:function(){var r=R(E().mark(function i(a){var n,l,u,h,m,p;return E().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(n=this._playlist.nextSegment,n){f.next=3;break}return f.abrupt("return");case 3:return l=!1,u=null,f.prev=5,this._segmentProcessing=!0,K.log("load segment, sn:".concat(n.sn,", [").concat(n.start,", ").concat(n.end,"], partIndex:").concat(n.partIndex)),f.next=10,this._reqAndBufferSegment(n,this._playlist.getAudioSegment(n));case 10:l=f.sent,f.next=16;break;case 13:f.prev=13,f.t0=f.catch(5),u=f.t0;case 16:return f.prev=16,this._segmentProcessing=!1,f.finish(16);case 19:if(!u){f.next=26;break}if(!this._bufferService.isFull()){f.next=25;break}return K.log("load segment, sn:".concat(n.sn,", partIndex:").concat(n.partIndex)),this._segmentProcessing=!0,this._isProcessQuotaExceeded=!0,f.abrupt("return",!1);case 25:return f.abrupt("return",this._emitError(x.create(u)));case 26:return l&&(m=this.bufferInfo().end,this.isLive&&!this.media.seeking&&m&&Math.abs(n.end-m)>1&&(K.warn("segment: ".concat(n.sn," expected end=").concat(n.end,", real end=").concat(m)),this._playlist.feedbackLiveEdge(n,m)),p=((h=this._playlist.currentStream)===null||h===void 0?void 0:h.url)===n.parentUrl,this._urlSwitching&&!p&&(K.warn("pre playlist segment appended!"),this._bufferService.seamlessSwitch()),this.isLive&&this._urlSwitching&&p&&(this._urlSwitching=!1,this.emit(I.SWITCH_URL_SUCCESS,{url:this.config.url})),this._playlist.moveSegmentPointer(),n.isLast?this._end():a||this._loadSegment()),f.abrupt("return",l);case 28:case"end":return f.stop()}},i,this,[[5,13,16,19]])}));function e(i){return r.apply(this,arguments)}return e}()},{key:"_reqAndBufferSegment",value:function(){var r=R(E().mark(function i(a,n){var l,u,h,m,p,d,f,y,S,b,T;return E().wrap(function(w){for(;;)switch(w.prev=w.next){case 0:return u=a?a.cc:n.cc,h=this._prevSegCc!==u,m=[],w.prev=3,w.next=6,this._segmentLoader.load(a,n,h);case 6:m=w.sent,w.next=14;break;case 9:throw w.prev=9,w.t0=w.catch(3),w.t0.fatal=!1,this._segmentLoader.error=w.t0,w.t0;case 14:if(m[0]){w.next=16;break}return w.abrupt("return");case 16:return w.next=18,(l=this._bufferService).decryptBuffer.apply(l,at(m));case 18:if(p=w.sent,p){w.next=21;break}return w.abrupt("return");case 21:return d=a?a.sn:n.sn,f=a?a.start:n.start,y=this._playlist.currentStream,this._bufferService.createSource(p[0],p[1],y==null?void 0:y.videoCodec,y==null?void 0:y.audioCodec),S=Date.now(),b=this._prevSegSn===d-1,this.isLive&&this._urlSwitching&&(T=this.bufferInfo().end,this._playlist.updateSegmentsRanges(d,T),K.warn("update the new playlist liveEdge, segment id=".concat(d,", buffer start=").concat(T,", liveEdge=").concat(this._playlist.liveEdge)),f=T),w.next=30,this._bufferService.appendBuffer(a,n,p[0],p[1],h,b,f);case 30:return this.emit(I.APPEND_COST,{elapsed:Date.now()-S,url:a.url}),w.next=33,this._bufferService.evictBuffer(this.config.bufferBehind);case 33:return this._prevSegCc=u,this._prevSegSn=d,w.abrupt("return",!0);case 36:case"end":return w.stop()}},i,this,[[3,9]])}));function e(i,a){return r.apply(this,arguments)}return e}()},{key:"_onCheckQuotaExceeded",value:function(){var r=R(E().mark(function i(){var a,n,l,u,h,m;return E().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:a=this.media.currentTime,n=this.media.buffered,l=!1,u=0;case 4:if(!(u<n.length)){d.next=11;break}if(!(n.start(0)>=a&&a<n.end(u))){d.next=8;break}return l=!0,d.abrupt("break",11);case 8:u++,d.next=4;break;case 11:if(!this._bufferService.isFull()){d.next=17;break}if(h=l?this.config.bufferBehind:5,m=this.media.currentTime,!(m-h>0)){d.next=17;break}return d.next=17,this._bufferService.removeBuffer(0,m-h);case 17:case"end":return d.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_checkStreamTrackChange",value:function(e){var i=this._playlist.checkSegmentTrackChange(e,this._bufferService.nbSb);i&&this.switchURL(this.config.url,i.start+.2)}},{key:"_clear",value:function(){var r=R(E().mark(function i(){return E().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return clearTimeout(this._disconnectTimer),this._stopTick(),n.next=4,Promise.all([this._segmentLoader.cancel(),this._manifestLoader.stopPoll()]);case 4:this._segmentProcessing=!1;case 5:case"end":return n.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_reset",value:function(){var r=R(E().mark(function i(){var a,n,l=arguments;return E().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return n=l.length>0&&l[0]!==void 0?l[0]:!1,this._reloadOnPlay=!1,this._prevSegSn=null,this._prevSegCc=null,this._switchUrlOpts=null,this._playlist.reset(),this._segmentLoader.reset(),(a=this._seiService)===null||a===void 0||a.reset(),this._stats.reset(),h.next=11,this._clear();case 11:return h.abrupt("return",this._bufferService.reset(n));case 12:case"end":return h.stop()}},i,this)}));function e(){return r.apply(this,arguments)}return e}()},{key:"_end",value:function(){this._clear(),this._bufferService.endOfStream(),(this.media.readyState<=2||this.media.buffered.length>1)&&this._startTick()}},{key:"_stopTick",value:function(){this._tickTimer&&clearTimeout(this._tickTimer),this._tickTimer=null}},{key:"_startTick",value:function(){this._stopTick(),this._tickTimer=setTimeout(this._tick,this._tickInterval)}},{key:"_emitError",value:function(e){var i,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(((i=e.originError)===null||i===void 0?void 0:i.fatal)===!1)K.warn(e);else{var n,l,u;K.table(e),K.error(e),K.error((n=this.media)===null||n===void 0?void 0:n.error),(l=this.media)!==null&&l!==void 0&&l.readyState&&this.media.pause(),this._stopTick(),this._urlSwitching&&(this._urlSwitching=!1,this.emit(I.SWITCH_URL_FAILED,e)),this.emit(I.ERROR,e),a&&this._end(),(u=this._seiService)===null||u===void 0||u.reset()}return e}},{key:"_getSeamlessSwitchPoint",value:function(){var e=this.media,i=e.currentTime;if(!e.paused){var a,n=this._playlist.findSegmentIndexByTime(e.currentTime),l=this._playlist.getSegmentByIndex(n),u=(a=this._stats)===null||a===void 0?void 0:a.getStats().downloadSpeed;if(u&&l){var h=l.duration*this._playlist.currentStream.bitrate/u+1;i+=h}else i+=5}return i}},{key:"_tryEos",value:function(){var e,i,a=this.media,n=this._playlist,l=n.nextSegment,u=n.lastSegment,h=(!l||u&&z.isBuffered(a,u.start+u.duration/2))&&a.readyState&&a.duration>0&&((e=this._bufferService)===null||e===void 0?void 0:e.msIsOpened)&&!((i=this._bufferService)!==null&&i!==void 0&&i.msHasOpTasks);if(h){var m=this.bufferInfo();a.paused&&!a.currentTime&&(m=this.bufferInfo(m.nextStart||.5));var p=Math.abs(m.end-a.duration)<.1||!this.isLive&&u&&m.end>=u.start+u.duration;p&&this._bufferService.endOfStream()}}}],[{key:"isSupported",value:function(e){return!e||e==="video"||e==="audio"?W.isSupported():typeof WebAssembly<"u"}},{key:"enableLogger",value:function(){ae.enable(),we.enable()}},{key:"disableLogger",value:function(){ae.disable(),we.disable()}}]),t}(Ge);c(se,"version","3.0.20");try{localStorage.getItem("xgd")?se.enableLogger():se.disableLogger()}catch{}var Nt=function(){function o(s,t){var r=this;V(this,o),c(this,"_opts",null),c(this,"_plugin",null),c(this,"_onLowDecode",function(){var e,i,a,n,l=r._opts,u=l.media,h=l.innerDegrade;(e=r._plugin)===null||e===void 0||(i=e.player)===null||i===void 0||i.emit("lowdecode",u.degradeInfo),(a=r._plugin)===null||a===void 0||(n=a.player)===null||n===void 0||n.emit("core_event",M(M({},u.degradeInfo),{},{eventName:I.LOWDECODE})),h===1&&r._degrade(u.src)}),c(this,"_degrade",function(e){var i=r._plugin.player,a=i.video;if(!(a&&a.TAG!=="MVideo")){var n=i.video.degradeVideo;i.video=n,a.degrade(e),e&&(i.config.url=e);var l=i.root.firstChild;l.TAG==="MVideo"&&i.root.replaceChild(n,l);var u=r._plugin.constructor.pluginName.toLowerCase();i.unRegisterPlugin(u),i.once("canplay",function(){i.play()})}}),c(this,"forceDegradeToVideo",function(e){var i=r._opts.innerDegrade;i===1&&r._degrade(e)}),this._opts=s,this._plugin=t,this._init()}return G(o,[{key:"_init",value:function(){var t=this._opts,r=t.media,e=t.preloadTime,i=t.innerDegrade,a=t.isLive;if(r){if(!a&&r.setPlayMode){r.setPlayMode("VOD");return}i&&r.setAttribute("innerdegrade",i),e&&r.setAttribute("preloadtime",e),this._bindEvents()}}},{key:"_bindEvents",value:function(){var t=this._opts.media;t.addEventListener("lowdecode",this._onLowDecode)}},{key:"destroy",value:function(){var t,r;(t=this._opts)===null||t===void 0||(r=t.media)===null||r===void 0||r.removeEventListener("lowdecode",this._onLowDecode),this._plugin=null}}]),o}(),Ut=["currentTime"];function Bt(o,s){var t=s.player,r=t.currentTime,e={startTime:r};switch(oe(o)){case"boolean":e.seamless=o;break;case"object":{var i=o.currentTime,a=_e(o,Ut);Object.assign(e,a),typeof i=="number"&&(e.startTime=i);break}}return e}var Ve=function(o){me(t,o);var s=ve(t);function t(){var r;V(this,t);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return r=s.call.apply(s,[this].concat(i)),c(D(r),"logger",K),c(D(r),"hls",null),c(D(r),"pluginExtension",null),c(D(r),"getStats",function(){var n;return(n=r.hls)===null||n===void 0?void 0:n.getStats()}),c(D(r),"_onSwitchSubtitle",function(n){var l,u=n.lang;(l=r.hls)===null||l===void 0||l.switchSubtitleStream(u)}),c(D(r),"_keepPauseStatus",function(){var n=r.player.paused;n&&r.player.once("canplay",function(){r.player.pause()})}),r}return G(t,[{key:"core",get:function(){return this.hls}},{key:"version",get:function(){var e;return(e=this.hls)===null||e===void 0?void 0:e.version}},{key:"softDecode",get:function(){var e,i,a=(e=this.player)===null||e===void 0||(i=e.config)===null||i===void 0?void 0:i.mediaType;return!!a&&a!=="video"&&a!=="audio"}},{key:"beforePlayerInit",value:function(){var e=this,i=this.player.config,a=this.player.media||this.player.video,n=i.hls||{};if(!(!i.url&&!i.__allowHlsEmptyUrl__||!n.preferMMS&&W.isMMSOnly())){this.hls&&this.hls.destroy();var l=Object.getOwnPropertyDescriptor(this.player,"switchURL");(!l||l.writable)&&(this.player.switchURL=function(m,p){return new Promise(function(d,f){var y=e.player,S=e.hls;if(S){var b,T,N=Bt(p,e);y.config.url=m,S.switchURL(m,N).then(function(){return d(!0)}).catch(f),!N.seamless&&(b=e.player.config)!==null&&b!==void 0&&(T=b.hls)!==null&&T!==void 0&&T.keepStatusAfterSwitch&&e._keepPauseStatus()}else f()})});var u=this.player.switchURL;if(this.player.handleSource=!1,n.innerDegrade=n.innerDegrade||i.innerDegrade,(n.disconnectTime===null||n.disconnectTime===void 0)&&(n.disconnectTime=0),this.hls=new se(M({softDecode:this.softDecode,isLive:i.isLive,media:a,startTime:i.startTime,url:i.url},n)),this.softDecode||Te.defineGetterOrSetter(this.player,{url:{get:function(){var p,d;return(p=e.hls)===null||p===void 0||(d=p.media)===null||d===void 0?void 0:d.src},configurable:!0}}),this.softDecode&&(this.pluginExtension=new Nt(M({isLive:i.isLive,media:a},n),this),this.player.forceDegradeToVideo=function(){for(var m,p=arguments.length,d=new Array(p),f=0;f<p;f++)d[f]=arguments[f];return(m=e.pluginExtension)===null||m===void 0?void 0:m.forceDegradeToVideo.apply(m,d)}),i.isLive){var h;(h=this.player)===null||h===void 0||h.useHooks("replay",function(){var m;return(m=e.hls)===null||m===void 0?void 0:m.replay()})}this.on(ze,u),this.on(qe,this._onSwitchSubtitle),this.on(Je,this.destroy.bind(this)),this._transError(),this._transCoreEvent(P.TTFB),this._transCoreEvent(P.LOAD_START),this._transCoreEvent(P.LOAD_RESPONSE_HEADERS),this._transCoreEvent(P.LOAD_COMPLETE),this._transCoreEvent(P.LOAD_RETRY),this._transCoreEvent(P.SOURCEBUFFER_CREATED),this._transCoreEvent(P.MEDIASOURCE_OPENED),this._transCoreEvent(P.APPEND_BUFFER),this._transCoreEvent(P.REMOVE_BUFFER),this._transCoreEvent(P.BUFFEREOS),this._transCoreEvent(P.KEYFRAME),this._transCoreEvent(P.METADATA_PARSED),this._transCoreEvent(P.DEMUXED_TRACK),this._transCoreEvent(P.SEI),this._transCoreEvent(P.SEI_IN_TIME),this._transCoreEvent(P.SPEED),this._transCoreEvent(P.HLS_MANIFEST_LOADED),this._transCoreEvent(P.HLS_LEVEL_LOADED),this._transCoreEvent(P.STREAM_EXCEPTION),this._transCoreEvent(P.SWITCH_URL_SUCCESS),this._transCoreEvent(P.SWITCH_URL_FAILED),this._transCoreEvent(I.NO_AUDIO_TRACK),this._transCoreEvent(I.STREAM_PARSED),this._transCoreEvent(I.SUBTITLE_SEGMENTS),this._transCoreEvent(I.SUBTITLE_PLAYLIST),this._transCoreEvent(I.APPEND_COST),i.url&&this.hls.load(i.url,{reuseMse:!0}).catch(function(m){})}}},{key:"destroy",value:function(){var e;this.hls&&(this.hls.destroy(),this.hls=null),(e=this.pluginExtension)===null||e===void 0||e.destroy(),this.pluginExtension=null}},{key:"_transError",value:function(){var e=this;this.hls.on(I.ERROR,function(i){e.player&&e.player.emit(Ze,new et(e.player,i))})}},{key:"_transCoreEvent",value:function(e){var i=this;this.hls.on(e,function(a){i.player&&(i.player.emit("core_event",M(M({},a),{},{eventName:e})),e===P.SEI_IN_TIME&&i.hls.hasSubtitle&&i._emitSeiPaylodTime(a))})}},{key:"_emitSeiPaylodTime",value:function(e){try{var i=JSON.parse(Array.from(e.data.payload).map(function(a){return String.fromCharCode(a)}).join("").slice(0,-1));if(!i.rtmp_dts)return;this.player.emit("core_event",{eventName:I.SEI_PAYLOAD_TIME,time:i.rtmp_dts})}catch{}}}],[{key:"pluginName",get:function(){return"hls"}},{key:"isSupported",value:function(e,i){return se.isSupported(e,i)}}]),t}(Te);c(Ve,"Hls",se);c(Ve,"EVENT",I);export{Ve as H};
